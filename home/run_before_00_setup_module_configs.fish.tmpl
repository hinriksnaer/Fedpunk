#!/usr/bin/env fish
# Chezmoi run_before script: Sync module configurations to chezmoi source
# This runs on EVERY apply to ensure module configs are always fresh:
# 1. Deletes existing copied configs in home/
# 2. Re-copies fresh from enabled modules
# 3. Chezmoi then deploys the fresh copies to ~/.config/

# workingTree is the git repo root, we need to copy files into the home/ subdirectory
set -x FEDPUNK_SOURCE_DIR "{{ .chezmoi.workingTree }}/home"
set -x FEDPUNK_REPO_ROOT "{{ .chezmoi.workingTree }}"

echo "Setting up module configurations..."
echo ""

# Track configs copied
set -l created_count 0
set -l skipped_count 0

# Process each enabled module
{{- range .profile.modules }}
set module_name "{{ . }}"
set module_path "$FEDPUNK_REPO_ROOT/modules/$module_name"
set config_path "$module_path/config"

# Check if module has a config directory
if test -d "$config_path"
    # Find all files/directories in module config (relative paths)
    set config_items (find "$config_path" -mindepth 1 -maxdepth 1 -type d -o -type f)

    for item in $config_items
        set item_name (basename "$item")

        # Special handling for dot_config directory - link contents, not the directory itself
        if test "$item_name" = "dot_config" -a -d "$item"
            # Ensure dot_config exists in source
            mkdir -p "$FEDPUNK_SOURCE_DIR/dot_config"

            # Link each item inside dot_config
            set dot_config_items (find "$item" -mindepth 1 -maxdepth 1)
            for subitem in $dot_config_items
                set subitem_name (basename "$subitem")
                set target_path "$FEDPUNK_SOURCE_DIR/dot_config/$subitem_name"

                # Remove any existing file/dir/symlink to ensure fresh copy
                if test -e "$target_path" -o -L "$target_path"
                    rm -rf "$target_path"
                end

                # Copy fresh from module
                cp -r "$subitem" "$target_path"
                echo "  • Copied: dot_config/$subitem_name ← modules/$module_name/config/"
                set created_count (math $created_count + 1)
            end
        else
            # Regular files/directories - copy directly to home/
            set target_path "$FEDPUNK_SOURCE_DIR/$item_name"

            # Remove existing to ensure fresh copy
            if test -e "$target_path" -o -L "$target_path"
                rm -rf "$target_path"
            end

            # Copy fresh from module
            cp -r "$item" "$target_path"
            echo "  • Copied: $item_name ← modules/$module_name/config/"
            set created_count (math $created_count + 1)
        end
    end
end
{{- end }}

echo ""
if test $created_count -gt 0
    echo "✓ Copied $created_count module config(s)"
end
if test $skipped_count -gt 0
    echo "⚠ Skipped $skipped_count item(s)"
end
echo "Module configurations ready"
echo ""
