#!/usr/bin/env fish
# Chezmoi run_before script: Copy module configurations to chezmoi source
# This runs FIRST to copy enabled module configs into the chezmoi source directory
# Chezmoi can then process and deploy these configs normally

# workingTree is the git repo root, we need to copy files into the home/ subdirectory
set -x FEDPUNK_SOURCE_DIR "{{ .chezmoi.workingTree }}/home"
set -x FEDPUNK_REPO_ROOT "{{ .chezmoi.workingTree }}"

echo "Setting up module configurations..."
echo ""

# Track configs copied
set -l created_count 0
set -l skipped_count 0

# Process each enabled module
{{- range .profile.modules }}
set module_name "{{ . }}"
set module_path "$FEDPUNK_REPO_ROOT/modules/$module_name"
set config_path "$module_path/config"

# Check if module has a config directory
if test -d "$config_path"
    # Find all files/directories in module config (relative paths)
    set config_items (find "$config_path" -mindepth 1 -maxdepth 1 -type d -o -type f)

    for item in $config_items
        set item_name (basename "$item")

        # Special handling for dot_config directory - link contents, not the directory itself
        if test "$item_name" = "dot_config" -a -d "$item"
            # Ensure dot_config exists in source
            mkdir -p "$FEDPUNK_SOURCE_DIR/dot_config"

            # Link each item inside dot_config
            set dot_config_items (find "$item" -mindepth 1 -maxdepth 1)
            for subitem in $dot_config_items
                set subitem_name (basename "$subitem")
                set target_path "$FEDPUNK_SOURCE_DIR/dot_config/$subitem_name"

                # Remove any existing symlink (we copy now, don't symlink)
                if test -L "$target_path"
                    rm "$target_path"
                else if test -e "$target_path"
                    echo "  ⚠ Skipping dot_config/$subitem_name (exists as file/dir)"
                    set skipped_count (math $skipped_count + 1)
                    continue
                end

                # Copy module config to chezmoi source
                if not test -e "$target_path"
                    cp -r "$subitem" "$target_path"
                    echo "  • Copied: dot_config/$subitem_name ← modules/$module_name/config/"
                    set created_count (math $created_count + 1)
                else
                    # Update existing files
                    cp -r "$subitem"/* "$target_path/"
                    echo "  • Updated: dot_config/$subitem_name"
                end
            end
        else
            # Regular files - copy directly
            set target_path "$FEDPUNK_SOURCE_DIR/$item_name"

            # Copy module config file to chezmoi source
            if test -d "$item"
                # Directory - copy recursively
                if not test -e "$target_path"
                    cp -r "$item" "$target_path"
                    echo "  • Copied: $item_name ← modules/$module_name/config/"
                    set created_count (math $created_count + 1)
                else
                    # Update existing directory
                    cp -r "$item"/* "$target_path/"
                    echo "  • Updated: $item_name"
                end
            else
                # Regular file - just copy
                cp "$item" "$target_path"
                if test $status -eq 0
                    echo "  • Copied: $item_name ← modules/$module_name/config/"
                    set created_count (math $created_count + 1)
                end
            end
        end
    end
end
{{- end }}

echo ""
if test $created_count -gt 0
    echo "✓ Copied $created_count module config(s)"
end
if test $skipped_count -gt 0
    echo "⚠ Skipped $skipped_count item(s)"
end
echo "Module configurations ready"
echo ""
