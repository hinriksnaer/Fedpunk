{{- if and .install.nvidia_drivers (ne .mode.name "container") }}
#!/usr/bin/env fish
# Install NVIDIA proprietary drivers and Wayland support

source "{{ .chezmoi.sourceDir }}/core/lib/helpers.fish"

section "NVIDIA Drivers"

# Detect NVIDIA GPU
if not command -v lspci >/dev/null 2>&1
    warning "lspci not found - cannot detect GPU"
    exit 0
end

if not lspci 2>/dev/null | grep -i nvidia >/dev/null 2>&1
    info "No NVIDIA GPU detected - skipping driver installation"
    exit 0
end

info "NVIDIA GPU detected"

# Check if drivers already installed
if command -v nvidia-smi >/dev/null 2>&1
    set driver_version (nvidia-smi --query-gpu=driver_version --format=csv,noheader 2>/dev/null | head -1)
    if test -n "$driver_version"
        success "NVIDIA drivers already installed (version: $driver_version)"
        exit 0
    end
end

# Check environment variable or prompt
set install_drivers false

if set -q FEDPUNK_INSTALL_NVIDIA_DRIVERS
    # Use environment variable
    if test "$FEDPUNK_INSTALL_NVIDIA_DRIVERS" = "true"
        set install_drivers true
        info "Installing NVIDIA drivers (FEDPUNK_INSTALL_NVIDIA_DRIVERS=true)"
    else
        info "Skipping NVIDIA drivers (FEDPUNK_INSTALL_NVIDIA_DRIVERS=$FEDPUNK_INSTALL_NVIDIA_DRIVERS)"
        exit 0
    end
else
    # Prompt user
    echo ""
    if confirm "Install NVIDIA proprietary drivers?"
        set install_drivers true
    else
        info "Skipping NVIDIA driver installation"
        exit 0
    end
end

if test "$install_drivers" = "true"
    subsection "Installing NVIDIA drivers"

    # Install drivers
    step "Installing NVIDIA kernel modules" "sudo dnf install -qy akmod-nvidia"
    step "Installing NVIDIA userspace drivers" "sudo dnf install -qy xorg-x11-drv-nvidia-cuda"

    # Wayland support
    step "Installing NVIDIA Wayland support" "sudo dnf install -qy nvidia-vaapi-driver libva-nvidia-driver"

    echo ""
    box "NVIDIA Drivers Installed!

The NVIDIA proprietary drivers have been installed.

‚ö†Ô∏è  REBOOT REQUIRED
The system must be rebooted for drivers to take effect.

After reboot, verify with: nvidia-smi

üí° Configuration:
- Hyprland env vars: ~/.config/hypr/conf.d/nvidia.conf
- Fish env vars: ~/.config/fish/conf.d/installer-managed.fish" $GUM_SUCCESS

    echo ""
    warning "System reboot required for drivers to take effect"
end
{{- end }}
