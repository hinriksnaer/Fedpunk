#!/usr/bin/env fish
# Post-deployment: Install tmux plugins
# This runs after chezmoi applies configs, guaranteeing tmux.conf exists
# Note: Only runs if tmux is installed

# Check if tmux is installed
if not command -v tmux >/dev/null 2>&1
    echo "ℹ tmux not installed, skipping plugin setup"
    exit 0
end

echo ""
echo "Tmux Plugin Setup"
echo "================="
echo ""

# Setup tmux plugin manager
if not test -d $HOME/.tmux/plugins/tpm
    gum spin --spinner dot --title "Installing tmux plugin manager..." -- \
        git clone --quiet https://github.com/tmux-plugins/tpm ~/.tmux/plugins/tpm 2>/dev/null
    echo "✓ Tmux plugin manager installed"
else
    echo "✓ Tmux plugin manager already installed"
end

# Install tmux plugins (config is guaranteed to exist now)
if test -f "$HOME/.config/tmux/tmux.conf"
    gum spin --spinner dot --title "Installing tmux plugins..." -- fish -c '
        set token tpm_done
        tmux start-server \; \
          set -g exit-empty off \; \
          source-file $HOME/.config/tmux/tmux.conf \; \
          run-shell "$HOME/.tmux/plugins/tpm/scripts/install_plugins.sh && tmux wait-for -S $token" \; \
          wait-for "$token" \; \
          set -g exit-empty on
    ' 2>/dev/null
    echo "✓ Tmux plugins installed"
else
    echo "⚠ tmux config not found, skipping plugin installation"
end

echo ""
