#!/usr/bin/env fish
# ============================================================================
# MODE CONFIGURATION: Load mode settings
# ============================================================================
# Purpose:
#   - Load mode YAML file (modes/$MODE.yaml)
#   - Parse install flags â†’ FEDPUNK_INSTALL_* environment variables
#   - Make available to all subsequent scripts
# Runs: Before file deployment (all modes)
# ============================================================================

# Initialize FEDPUNK_PATH if not set
if not set -q FEDPUNK_PATH
    set -gx FEDPUNK_PATH "{{ .chezmoi.sourceDir }}"
end

# Set FEDPUNK_MODE from template data
if not set -q FEDPUNK_MODE
    set -gx FEDPUNK_MODE "{{ .mode.name }}"
end

# Set log file
if not set -q FEDPUNK_LOG_FILE
    set -gx FEDPUNK_LOG_FILE "/tmp/fedpunk-install-"(date +%Y%m%d-%H%M%S)".log"
    echo "Fedpunk Installation Log - "(date) > $FEDPUNK_LOG_FILE
    echo "Mode: $FEDPUNK_MODE" >> $FEDPUNK_LOG_FILE
    echo "=================================" >> $FEDPUNK_LOG_FILE
    echo "" >> $FEDPUNK_LOG_FILE
end

# Source helpers
source "$FEDPUNK_PATH/home/core/lib/helpers.fish"

section "Mode Configuration"

info "Mode: $FEDPUNK_MODE"
info "Loading configuration from: modes/$FEDPUNK_MODE.yaml"

# Load mode configuration
load_mode_config

if test $status -eq 0
    success "Mode configuration loaded"
else
    error "Failed to load mode configuration"
    exit 1
end

# Log all FEDPUNK_INSTALL_* variables
echo "" >> $FEDPUNK_LOG_FILE
echo "[MODE CONFIG] Loaded variables:" >> $FEDPUNK_LOG_FILE
for var in (set -xg | grep FEDPUNK_INSTALL_)
    echo "  $var" >> $FEDPUNK_LOG_FILE
end
echo "" >> $FEDPUNK_LOG_FILE

echo ""
box "Mode Configuration Complete!" $GUM_SUCCESS
