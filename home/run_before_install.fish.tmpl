#!/usr/bin/env fish
# Chezmoi run_before script: Execute module before_apply hooks
# This runs BEFORE chezmoi applies configs

# Set up environment
set -x FEDPUNK_PATH "{{ .chezmoi.workingTree }}"
set -x FEDPUNK_LIB_PATH "$FEDPUNK_PATH/lib"
set -x FEDPUNK_MODE "{{ .mode.name }}"
set -x FEDPUNK_LOG_FILE "/tmp/fedpunk-install-"(date +%Y%m%d-%H%M%S)".log"

echo "Fedpunk Installation (Profile: {{ .profile.name }})"
echo "====================================================="
echo ""
echo "Mode: {{ .mode.name }}"
echo "Profile: {{ .profile.name }}"
echo "Modules: {{ join ", " .profile.modules }}"
echo ""

# Create log file
echo "Fedpunk Installation - "(date) > "$FEDPUNK_LOG_FILE"
echo "Mode: {{ .mode.name }}" >> "$FEDPUNK_LOG_FILE"
echo "Profile: {{ .profile.name }}" >> "$FEDPUNK_LOG_FILE"
echo "" >> "$FEDPUNK_LOG_FILE"

# Source module loader library
source "$FEDPUNK_LIB_PATH/modules.fish"
source "$FEDPUNK_LIB_PATH/helpers.fish"

# Export module environment variables
{{- range $moduleName := .profile.modules }}
{{-   $modKey := $moduleName | replace "-" "_" }}
{{-   $modData := index .module $modKey | default dict }}
{{-   $modulePrefix := printf "FEDPUNK_MODULE_%s" ($moduleName | upper | replace "-" "_") }}
{{-   range $key, $value := $modData }}
set -gx {{ $modulePrefix }}_{{ $key }} {{ $value | quote }}
{{-   end }}
{{- end }}

# Execute before_apply hooks
{{- $hooks := .profile.before_apply_hooks | mustFromJson }}
{{- if $hooks }}
section "Running before_apply hooks ({{ len $hooks }} modules)"
echo ""

{{-   range $index, $hookStr := $hooks }}
{{-     $parts := split ":" $hookStr }}
{{-     $moduleName := index $parts 0 }}
{{-     $script := index $parts 1 }}

# Module {{ add $index 1 }}/{{ len $hooks }}: {{ $moduleName }}
echo ""
info "Module: {{ $moduleName }}"

# Check if module should run (auto-detection, mode-enabled, etc.)
if should_run_module "{{ $moduleName }}"
    execute_module_hook "{{ $moduleName }}" "{{ $script }}" "before_apply"
    if test $status -ne 0
        error "Module hook failed: {{ $moduleName }}/{{ $script }}"
        exit 1
    end
else
    info "Skipping module: {{ $moduleName }}"
end
{{-   end }}
{{- else }}
info "No before_apply hooks configured"
{{- end }}

echo ""
echo "====================================================="
echo "All before_apply hooks complete"
echo "Log file: $FEDPUNK_LOG_FILE"
echo ""
