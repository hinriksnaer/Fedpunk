#!/usr/bin/env fish
# Fedpunk Reload Script
# Applies chezmoi changes and reloads all services

set fedpunk_dir "$HOME/.local/share/fedpunk"

echo "ğŸ”„ Fedpunk Reload"
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

# Check for uncommitted changes
cd $fedpunk_dir
if test -n "$(git status --porcelain)"
    echo "âš ï¸  Warning: You have uncommitted changes in $fedpunk_dir"
    git status --short
    echo ""
end

# Check for merge conflicts
set conflicts (chezmoi status | grep "^MM")
if test -n "$conflicts"
    echo "âš ï¸  Warning: Merge conflicts detected in the following files:"
    for conflict in $conflicts
        if test "$conflict" != "MM"
            echo "  - $conflict"
        end
    end
    echo ""
    echo "These files have been modified both locally and in the repository."
    echo "They will NOT be applied automatically to preserve your changes."
    echo ""
    echo "To resolve:"
    echo "  - Keep your changes: chezmoi merge <file>"
    echo "  - Use repository version: chezmoi apply --force <file>"
    echo "  - See differences: chezmoi diff <file>"
    echo ""
end

# Apply chezmoi changes
echo "ğŸ“¦ Applying chezmoi..."
if chezmoi apply --source $fedpunk_dir
    # Check if any files were actually skipped
    set skipped (chezmoi status | grep "^ M")
    if test -n "$skipped"
        echo "âš ï¸  Some files were not applied (see conflicts above)"
    else
        echo "âœ“ Chezmoi applied successfully"
    end
else
    echo "âœ— Chezmoi apply failed"
    exit 1
end

echo ""

# Reload Hyprland
echo "ğŸªŸ Reloading Hyprland..."
if hyprctl reload >/dev/null 2>&1
    echo "âœ“ Hyprland reloaded"
else
    echo "âœ— Hyprland reload failed (not running?)"
end

# Reload Waybar
echo "ğŸ“Š Reloading Waybar..."
if pkill -SIGUSR2 waybar
    echo "âœ“ Waybar reloaded"
else
    echo "âœ— Waybar reload failed (not running?)"
end

echo ""
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
echo "âœ¨ Reload complete!"
