{{- /* Fedpunk Mode Detection */ -}}
{{- /* Priority: Explicit env var > Interactive prompt > Auto-detection > Default */ -}}

{{- $mode := "desktop" -}}
{{- $autoDetectedMode := "" -}}

{{- /* Auto-detect mode for smart defaults */ -}}
{{- if or (env "CONTAINER") (stat "/.dockerenv") (stat "/run/.containerenv") -}}
{{-   $autoDetectedMode = "container" -}}
{{-   $mode = "container" -}}
{{- else if stat "/sys/class/power_supply/BAT0" -}}
{{-   $autoDetectedMode = "laptop" -}}
{{-   $mode = "laptop" -}}
{{- else -}}
{{-   $autoDetectedMode = "desktop" -}}
{{-   $mode = "desktop" -}}
{{- end -}}

{{- /* 1. Check for explicit mode override */ -}}
{{- if env "FEDPUNK_MODE" -}}
{{-   $mode = env "FEDPUNK_MODE" -}}

{{- /* 2. Interactive prompt (if not in non-interactive mode) */ -}}
{{- else if not (env "FEDPUNK_NON_INTERACTIVE") -}}
{{-   $mode = promptChoice "mode" (list "desktop" "laptop" "container") $autoDetectedMode -}}

{{- /* 3. Use auto-detected mode (non-interactive mode) */ -}}
{{- end -}}

{{- /* Get profile from environment, default to "dev" */ -}}
{{- $profile := env "FEDPUNK_PROFILE" | default "dev" -}}

[data]
  [data.mode]
    name = {{ $mode | quote }}
  [data.profile]
    name = {{ $profile | quote }}

{{- /* Define what to install based on mode */ -}}
{{- if eq $mode "desktop" }}
  [data.install]
    desktop_preflight = true
    yazi = true
    claude = true
    gh = true
    tmux = true
    neovim = true
    btop = true
    lazygit = true
    cli_tools = true
    languages = true
    firefox = true
    fonts = true
    audio = true
    multimedia = true
    bluetooth = true
    extra_apps = true
    kitty = true
    hyprland = true
    rofi = true
{{- else if eq $mode "container" }}
  [data.install]
    desktop_preflight = false
    yazi = true
    claude = true
    gh = true
    neovim = true
    lazygit = true
    cli_tools = true
    languages = true
    firefox = false
    fonts = false
    audio = false
    multimedia = false
    bluetooth = false
    extra_apps = false
    kitty = false
    hyprland = false
    rofi = false
    tmux = false
    btop = false
{{- else if eq $mode "laptop" }}
  [data.install]
    desktop_preflight = true
    yazi = true
    claude = true
    gh = true
    tmux = true
    neovim = true
    btop = true
    lazygit = true
    cli_tools = true
    languages = true
    firefox = true
    fonts = true
    audio = true
    multimedia = true
    bluetooth = true
    extra_apps = true
    kitty = true
    hyprland = true
    rofi = true
{{- end }}

# Mode: {{ $mode }} {{- if env "FEDPUNK_MODE" }} (explicit){{- else if not (env "FEDPUNK_NON_INTERACTIVE") }} (user selected){{- else }} (auto-detected){{- end }}
{{- if $autoDetectedMode }}
# Auto-detected as: {{ $autoDetectedMode }}
{{- end }}
# Profile: {{ $profile }}
