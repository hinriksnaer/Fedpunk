{{- /* Fedpunk Mode Detection */ -}}
{{- /* Priority: Explicit env var > Interactive prompt > Auto-detection > Default */ -}}

{{- $mode := "desktop" -}}
{{- $autoDetectedMode := "" -}}

{{- /* Auto-detect mode for smart defaults */ -}}
{{- if or (env "CONTAINER") (stat "/.dockerenv") (stat "/run/.containerenv") -}}
{{-   $autoDetectedMode = "container" -}}
{{-   $mode = "container" -}}
{{- else if stat "/sys/class/power_supply/BAT0" -}}
{{-   $autoDetectedMode = "laptop" -}}
{{-   $mode = "laptop" -}}
{{- else -}}
{{-   $autoDetectedMode = "desktop" -}}
{{-   $mode = "desktop" -}}
{{- end -}}

{{- /* 1. Check for explicit mode override */ -}}
{{- if env "FEDPUNK_MODE" -}}
{{-   $mode = env "FEDPUNK_MODE" -}}

{{- /* 2. Interactive prompt (if not in non-interactive mode) */ -}}
{{- else if not (env "FEDPUNK_NON_INTERACTIVE") -}}
{{-   $mode = promptChoice "mode" (list "desktop" "laptop" "container") $autoDetectedMode -}}

{{- /* 3. Use auto-detected mode (non-interactive mode) */ -}}
{{- end -}}

{{- /* Get profile from environment, default to "dev" */ -}}
{{- $profile := env "FEDPUNK_PROFILE" | default "dev" -}}

{{- /* Load mode configuration from JSON file */ -}}
{{- $modeFile := joinPath .chezmoi.sourceDir ".." "profiles" $profile "modes" (printf "%s.json" $mode) -}}
{{- $modeConfig := dict -}}
{{- if stat $modeFile -}}
{{-   $modeConfig = include $modeFile | fromJson -}}
{{- else -}}
{{-   $modeFile = joinPath .chezmoi.sourceDir ".." "profiles" $profile "modes" "desktop.json" -}}
{{-   $modeConfig = include $modeFile | fromJson -}}
{{- end -}}

[data]
  [data.mode]
    name = {{ $mode | quote }}
    description = {{ $modeConfig.description | quote }}
  [data.profile]
    name = {{ $profile | quote }}

  [data.install]
{{- range $key, $value := $modeConfig.install }}
    {{ $key }} = {{ $value }}
{{- end }}

# Mode: {{ $mode }} {{- if env "FEDPUNK_MODE" }} (explicit){{- else if not (env "FEDPUNK_NON_INTERACTIVE") }} (user selected){{- else }} (auto-detected){{- end }}
{{- if $autoDetectedMode }}
# Auto-detected as: {{ $autoDetectedMode }}
{{- end }}
# Profile: {{ $profile }}
