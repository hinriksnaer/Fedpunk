{{- $mode := "desktop" -}}
{{- $autoDetectedMode := "" -}}

{{/* Auto-detect mode based on environment */}}
{{- if or (env "CONTAINER") (stat "/.dockerenv") (stat "/run/.containerenv") -}}
{{-   $autoDetectedMode = "container" -}}
{{-   $mode = "container" -}}
{{- else if stat "/sys/class/power_supply/BAT0" -}}
{{-   $autoDetectedMode = "laptop" -}}
{{-   $mode = "laptop" -}}
{{- else -}}
{{-   $autoDetectedMode = "desktop" -}}
{{-   $mode = "desktop" -}}
{{- end -}}

{{/* Allow override via environment or prompt */}}
{{- if env "FEDPUNK_MODE" -}}
{{-   $mode = env "FEDPUNK_MODE" -}}
{{- else if env "FEDPUNK_NON_INTERACTIVE" -}}
{{/* Non-interactive: use auto-detected mode (already set above) */}}
{{- else -}}
{{-   $mode = promptChoice "mode" (list "desktop" "laptop" "container") $autoDetectedMode -}}
{{- end -}}

{{/* Load profile */}}
{{- $profile := env "FEDPUNK_PROFILE" | default "dev" -}}
{{- $profilePath := joinPath .chezmoi.workingTree "profiles" $profile -}}
{{- $manifestPath := joinPath $profilePath "fedpunk.yaml" -}}
{{- $manifest := include $manifestPath | fromYaml -}}

[data]
  [data.mode]
    name = {{ $mode | quote }}

  [data.profile]
    name = {{ $profile | quote }}
    path = {{ $profilePath | quote }}
    description = {{ $manifest.profile.description | default "" | quote }}

# Mode: {{ $mode }}
# Profile: {{ $profile }}
