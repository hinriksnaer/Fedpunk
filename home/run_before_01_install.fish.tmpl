#!/usr/bin/env fish
# Fedpunk Installation Script
# Runs install scripts before deploying dotfiles

set -x FEDPUNK_PATH "{{ .chezmoi.workingTree }}"
set -x FEDPUNK_MODE "{{ .mode.name }}"
set -x FEDPUNK_LOG_FILE "/tmp/fedpunk-install-"(date +%Y%m%d-%H%M%S)".log"

# Load mode configuration (sets FEDPUNK_INSTALL_* variables)
source "$FEDPUNK_PATH/lib/helpers.fish"
load_mode_config

echo "╔═══════════════════════════════════════════════════════╗"
echo "║                                                       ║"
echo "║              Fedpunk Installation                     ║"
echo "║                                                       ║"
echo "╚═══════════════════════════════════════════════════════╝"
echo ""
echo "Configuration:"
echo "  Mode:    {{ .mode.name }}"
echo ""
echo "Log: $FEDPUNK_LOG_FILE"
echo "───────────────────────────────────────────────────────"
echo ""

# Create log file
echo "Fedpunk Installation - "(date) > "$FEDPUNK_LOG_FILE"
echo "Mode: {{ .mode.name }}" >> "$FEDPUNK_LOG_FILE"
echo "" >> "$FEDPUNK_LOG_FILE"

# Run install scripts in order
set install_dir "$FEDPUNK_PATH/home/install"
if test -d "$install_dir"
    echo "Running install scripts..."
    echo ""

    for script in (ls "$install_dir"/*.fish 2>/dev/null | sort)
        set script_name (basename "$script")
        echo "→ Running $script_name..."

        fish "$script" 2>&1 | tee -a "$FEDPUNK_LOG_FILE"

        if test $status -ne 0
            echo ""
            echo "ERROR: Installation script failed: $script_name"
            echo "Check log: $FEDPUNK_LOG_FILE"
            exit 1
        end

        echo ""
    end

    echo "====================================================="
    echo "Installation complete"
    echo "Log file: $FEDPUNK_LOG_FILE"
    echo ""
else
    echo "No install scripts found"
    echo ""
end
