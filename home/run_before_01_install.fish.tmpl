#!/usr/bin/env fish
# Chezmoi run_before script: Execute module before_apply hooks
# This runs BEFORE chezmoi applies configs

# Set up environment
set -x FEDPUNK_PATH "{{ .chezmoi.workingTree }}"
set -x FEDPUNK_LIB_PATH "$FEDPUNK_PATH/lib"
set -x FEDPUNK_MODE "{{ .mode.name }}"
set -x FEDPUNK_LOG_FILE "/tmp/fedpunk-install-"(date +%Y%m%d-%H%M%S)".log"

echo "╔═══════════════════════════════════════════════════════╗"
echo "║                                                       ║"
echo "║              Fedpunk Installation                     ║"
echo "║                                                       ║"
echo "╚═══════════════════════════════════════════════════════╝"
echo ""
echo "Configuration:"
echo "  Mode:    {{ .mode.name }}"
echo "  Profile: {{ .profile.name }}"
echo "  Path:    {{ .profile.path }}"
echo ""
echo "Modules ({{ len .profile.modules }}):"
{{- range .profile.modules }}
echo "  • {{ . }}"
{{- end }}
echo ""
echo "Installation phases:"
echo "  1. Before-apply hooks ({{ len .profile.before_apply_hooks }} modules)"
echo "  2. Dotfile deployment"
echo "  3. After-apply hooks ({{ len .profile.after_apply_hooks }} modules)"
echo ""
echo "Log: $FEDPUNK_LOG_FILE"
echo "───────────────────────────────────────────────────────"
echo ""

# Create log file
echo "Fedpunk Installation - "(date) > "$FEDPUNK_LOG_FILE"
echo "Mode: {{ .mode.name }}" >> "$FEDPUNK_LOG_FILE"
echo "Profile: {{ .profile.name }}" >> "$FEDPUNK_LOG_FILE"
echo "Modules: {{ join ", " .profile.modules }}" >> "$FEDPUNK_LOG_FILE"
echo "" >> "$FEDPUNK_LOG_FILE"

# Source module loader library
source "$FEDPUNK_LIB_PATH/modules.fish"
source "$FEDPUNK_LIB_PATH/helpers.fish"

# Export module environment variables
{{- range $moduleName := .profile.modules }}
{{-   $modKey := $moduleName | replace "-" "_" }}
{{-   $modData := index $.module $modKey | default dict }}
{{-   $modulePrefix := printf "FEDPUNK_MODULE_%s" ($moduleName | upper | replace "-" "_") }}
{{-   range $key, $value := $modData }}
set -gx {{ $modulePrefix }}_{{ $key }} {{ $value | quote }}
{{-   end }}
{{- end }}

# Execute before_apply hooks
{{- if .profile.before_apply_hooks }}

{{-   range $index, $hookStr := .profile.before_apply_hooks }}

# Module {{ add $index 1 }}/{{ len $.profile.before_apply_hooks }}: {{ $hookStr }}
echo ""

# Parse hook string (format: "module:script")
set -l hook_parts (string split ":" "{{ $hookStr }}")
set -l module_name $hook_parts[1]
set -l script_name $hook_parts[2]

info "Module: $module_name"

# Check if module should run (auto-detection, mode-enabled, etc.)
if should_run_module "$module_name"
    execute_module_hook "$module_name" "$script_name" "before_apply"
    if test $status -ne 0
        error "Module hook failed: $module_name/$script_name"
        exit 1
    end
else
    info "Skipping module: $module_name"
end
{{-   end }}
{{- else }}
info "No before_apply hooks configured"
{{- end }}

echo ""
echo "====================================================="
echo "All before_apply hooks complete"
echo "Log file: $FEDPUNK_LOG_FILE"
echo ""
