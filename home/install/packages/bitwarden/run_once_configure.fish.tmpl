#!/usr/bin/env fish
{{- if .install.bitwarden }}
# Setup Bitwarden password manager (GUI + CLI)
# Installs both the desktop app via Flatpak and the CLI tool
#
# Usage: setup-bitwarden.fish [--force|--reinstall]

source "{{ .chezmoi.workingTree }}/home/install/lib/helpers.fish"

# Parse arguments
set -l force_reinstall false
for arg in $argv
    switch $arg
        case '--force' '--reinstall'
            set force_reinstall true
    end
end

section "Bitwarden Setup"

# Skip in container mode (CLI not useful without GUI browser access)
if test "$FEDPUNK_MODE" = "container"
    info "Skipping Bitwarden setup in container mode"
    info "Bitwarden CLI requires GUI browser access for authentication"
    echo ""
    exit 0
end

# Require TTY for interactive prompts (or environment variable override)
require_tty "Bitwarden Setup" "FEDPUNK_SETUP_BITWARDEN=skip|install"

# Uninstall if force reinstall is requested
if test "$force_reinstall" = true
    warning "Force reinstall requested - uninstalling existing installations..."
    echo ""

    # Uninstall Flatpak GUI
    if flatpak list --app 2>/dev/null | grep -q "com.bitwarden.desktop"
        step "Uninstalling Bitwarden desktop app" "flatpak uninstall -y com.bitwarden.desktop"
    end

    # Uninstall CLI
    if command -v bw >/dev/null 2>&1
        info "Uninstalling Bitwarden CLI..."

        # Try npm uninstall first
        if command -v npm >/dev/null 2>&1
            sudo npm uninstall -g @bitwarden/cli 2>/dev/null
        end

        # Remove binary installations
        sudo rm -f /usr/local/bin/bw
        sudo rm -f /usr/bin/bw
        rm -f ~/.local/bin/bw

        if not command -v bw >/dev/null 2>&1
            success "Bitwarden CLI uninstalled"
        else
            warning "Some CLI remnants may remain"
        end
    end

    echo ""
end

# Check if CLI already installed
set cli_installed false
if command -v bw >/dev/null 2>&1
    success "Bitwarden CLI already installed: "(bw --version)
    set cli_installed true
end

# Check if GUI already installed
set gui_installed false
if flatpak list --app 2>/dev/null | grep -q "com.bitwarden.desktop"
    success "Bitwarden desktop app already installed (Flatpak)"
    set gui_installed true
end

if test "$cli_installed" = true -a "$gui_installed" = true
    info "Both Bitwarden CLI and GUI are already installed"
    exit 0
end

subsection "Installing dependencies"

# Detect if we're in a container (skip GUI installation)
set in_container false
if test -n "$FEDPUNK_MODE"; and test "$FEDPUNK_MODE" = "container"
    set in_container true
    info "Container mode detected - skipping GUI installation"
else if test -f /.dockerenv; or test -f /run/.containerenv
    set in_container true
    info "Container detected - skipping GUI installation"
end

# Install GUI only if not in container
if test "$in_container" = false
    # Install Flatpak if not available
    if not command -v flatpak >/dev/null 2>&1
        install_package flatpak
    end

    # Add Flathub repository if not already added
    if not flatpak remotes 2>/dev/null | grep -q flathub
        step "Adding Flathub repository" "sudo flatpak remote-add --if-not-exists flathub https://flathub.org/repo/flathub.flatpakrepo"
    else
        success "Flathub repository already configured"
    end

    # Install Bitwarden desktop app from Flathub
    if test "$gui_installed" = false
        subsection "Installing Bitwarden desktop app"

        flatpak install -y flathub com.bitwarden.desktop

        if test $status -eq 0
            success "Bitwarden desktop app installed successfully!"
            set gui_installed true
        else
            error "Failed to install Bitwarden desktop app"
        end
    end
else
    # In container: mark GUI as "installed" (not needed)
    set gui_installed true
    info "Skipping desktop app (not needed in containers)"
end

# Install Bitwarden CLI
if test "$cli_installed" = false
    subsection "Installing Bitwarden CLI"

    # Install via npm (most reliable method)
    if command -v npm >/dev/null 2>&1
        step "Installing Bitwarden CLI via npm" "sudo npm install -g @bitwarden/cli"
        if test $status -eq 0
            set cli_installed true
        else
            warning "Failed to install via npm, trying alternative method..."
        end
    else
        info "npm not found, installing Node.js first..."
        install_packages nodejs npm
        if test $status -eq 0
            step "Installing Bitwarden CLI via npm" "sudo npm install -g @bitwarden/cli"
            if test $status -eq 0
                set cli_installed true
            end
        end
    end

    # Fallback: download binary directly
    if test "$cli_installed" = false
        info "Installing Bitwarden CLI from binary..."

        # Get latest version using GitHub API
        set BW_VERSION (curl -s https://api.github.com/repos/bitwarden/clients/releases/latest | grep -o '"tag_name": *"[^"]*"' | grep -o 'cli-v[0-9.]*' | sed 's/cli-v//')

        if test -z "$BW_VERSION"
            error "Failed to detect latest Bitwarden CLI version"
        else
            info "Downloading version $BW_VERSION..."
            set BW_URL "https://github.com/bitwarden/clients/releases/download/cli-v$BW_VERSION/bw-linux-$BW_VERSION.zip"

            mkdir -p ~/.local/bin
            set temp_dir (mktemp -d)
            cd "$temp_dir"

            if curl -fL "$BW_URL" -o bw.zip 2>/dev/null
                if unzip -o bw.zip 2>/dev/null
                    chmod +x bw
                    mv bw ~/.local/bin/
                    cd - >/dev/null
                    rm -rf "$temp_dir"

                    if command -v bw >/dev/null 2>&1
                        success "Bitwarden CLI installed successfully!"
                        set cli_installed true
                    end
                else
                    error "Failed to extract Bitwarden CLI"
                    cd - >/dev/null
                    rm -rf "$temp_dir"
                end
            else
                error "Failed to download Bitwarden CLI from $BW_URL"
                cd - >/dev/null
                rm -rf "$temp_dir"
            end
        end
    end
end

# Helper function to save session key
function save_session_key
    set session_key $argv[1]
    echo ""
    gum style --foreground 212 "  set -Ux BW_SESSION \"$session_key\""
    echo ""
    if gum confirm "Save BW_SESSION for this user?" </dev/tty
        set -Ux BW_SESSION "$session_key"
        success "BW_SESSION saved! CLI is ready to use."
        return 0
    end
    return 1
end

# Helper function to perform login
function do_bw_login
    set email (gum input --placeholder "Enter your Bitwarden email" </dev/tty)
    test -z "$email"; and return 1

    echo ""
    info "Logging in as $email..."
    bw login "$email"; or return 1

    success "Login successful! Unlocking vault..."
    set session_key (bw unlock --raw)
    test -n "$session_key"; and save_session_key "$session_key"
end

# Helper function to unlock vault
function do_bw_unlock
    info "Unlocking vault..."
    set session_key (bw unlock --raw)
    test -n "$session_key"; and save_session_key "$session_key"
end

echo ""
if test "$gui_installed" = false -o "$cli_installed" = false
    warning "Bitwarden installation incomplete"
    test "$gui_installed" = false; and echo "  â€¢ Desktop app: Not installed"
    test "$cli_installed" = false; and echo "  â€¢ CLI: Not installed"
    exit 1
end

# Ask if user wants to set up CLI
echo ""
if not gum confirm "Set up Bitwarden CLI now?" </dev/tty
    box "Bitwarden Installed!

âœ“ Desktop app installed (search for 'Bitwarden' in app menu)
âœ“ CLI installed

Next steps:
  â€¢ Run 'bw login' to authenticate CLI

ðŸ’¡ Quick reference:
  bwg <name>  - Get password
  bwl         - List items
  bwgen       - Generate password
  bws         - Sync vault" $GUM_SUCCESS
    exit 0
end

subsection "Setting up Bitwarden CLI"

# Get current status
set bw_status (bw status 2>/dev/null | grep -o '"status":"[^"]*"' | cut -d'"' -f4)

# Handle each status
switch $bw_status
    case "unauthenticated"
        do_bw_login
    case "locked"
        do_bw_unlock
    case "unlocked"
        success "CLI is already unlocked and ready!"
    case "*"
        warning "Unknown status. Run: bw login"
end

# Offer to add SSH keys to Bitwarden
set bw_status (bw status 2>/dev/null | grep -o '"status":"[^"]*"' | cut -d'"' -f4)
if test "$bw_status" = "unlocked"
    # Check for SSH keys
    set ssh_keys
    for key_file in ~/.ssh/id_ed25519 ~/.ssh/id_rsa ~/.ssh/id_ecdsa
        if test -f "$key_file"
            set -a ssh_keys "$key_file"
        end
    end

    if test (count $ssh_keys) -gt 0
        echo ""
        if gum confirm "Add SSH keys to Bitwarden?" </dev/tty
            set script_dir (dirname (status -f))
            for key in $ssh_keys
                info "Adding $key to Bitwarden..."
                fish "$script_dir/bw-ssh-add.fish" "$key"
                if test $status -ne 0
                    warning "Failed to add $key"
                end
                echo ""
            end
        end
    end
end

echo ""
box "Bitwarden Setup Complete!

âœ“ Desktop app installed
âœ“ CLI installed and configured

Quick reference:
  bwg <name>  - Get password
  bwl         - List items
  bwgen       - Generate password
  bws         - Sync vault

ðŸ’¡ Access desktop app from application menu" $GUM_SUCCESS
echo ""
{{- end }}
