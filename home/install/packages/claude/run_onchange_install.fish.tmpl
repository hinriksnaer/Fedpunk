{{- if .install.claude -}}
#!/usr/bin/env fish
# Component: Claude Code
# Description: Install/Update Claude Code CLI
# Mode: {{ .mode.name }}

source "{{ .chezmoi.workingTree }}/home/install/lib/helpers.fish"

section "Claude Code Installation"

# Ensure npm is available
if not command -v npm >/dev/null 2>&1
    subsection "Installing Node.js and npm"
    install_packages nodejs npm
end

if command -v claude >/dev/null 2>&1
    set current_version (claude --version 2>/dev/null | grep -oP '\d+\.\d+\.\d+' | head -1)
    info "Current version: $current_version"

    # Always upgrade to latest version
    step "Updating Claude Code to latest version" "sudo npm update -g @anthropic/claude"

    set new_version (claude --version 2>/dev/null | grep -oP '\d+\.\d+\.\d+' | head -1)
    if test "$current_version" != "$new_version"
        success "Updated: $current_version â†’ $new_version"
    else
        success "Already on latest version: $new_version"
    end
else
    step "Installing Claude Code" "sudo npm install -g @anthropic/claude"
    if command -v claude >/dev/null 2>&1
        success "Installed: "(claude --version)
    else
        error "Installation failed"
        exit 1
    end
end

box "Claude Code Installation Complete!" $GUM_SUCCESS
{{- end }}
