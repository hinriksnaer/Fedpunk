{{- if ne .mode.name "container" -}}
#!/usr/bin/env fish
# Claude Code configuration
# Mode: {{ .mode.name }}

source "{{ .chezmoi.workingTree }}/home/install/lib/helpers.fish"

set chezmoi_data "$HOME/.config/chezmoi/chezmoi.toml"

section "Claude Code Configuration"

# Require TTY for interactive prompts
require_tty "Claude Code Setup" "FEDPUNK_SETUP_CLAUDE=skip|vertex"

# Check current configuration
{{- if and (hasKey . "claude") (hasKey .claude "use_vertex") }}
{{-   if .claude.use_vertex }}
info "Current configuration: Google Vertex AI (enabled)"
{{-   else }}
info "Current configuration: Standard API"
{{-   end }}
{{- else }}
info "No Claude configuration set"
{{- end }}

# Ask if user wants to enable Vertex AI
echo ""
if gum confirm "Enable Google Vertex AI for Claude Code?" </dev/tty
    # Enable Vertex AI
    subsection "Enabling Google Vertex AI"

    # Update chezmoi data file
    if not grep -q "^\[data\.claude\]" "$chezmoi_data" 2>/dev/null
        echo "" >> "$chezmoi_data"
        echo "[data.claude]" >> "$chezmoi_data"
    end

    # Remove old claude settings if they exist
    sed -i '/^\[data\.claude\]/,/^\[/{ /^\[data\.claude\]/!{ /^\[/!d; }; }' "$chezmoi_data"

    # Add setting
    sed -i "/^\[data\.claude\]/a\\  use_vertex = true" "$chezmoi_data"

    success "Google Vertex AI enabled"
    echo ""
    box "Vertex AI Configuration

⚠️  Run 'chezmoi apply' to activate:
  chezmoi apply

Environment variables (will be auto-loaded):
  CLAUDE_CODE_USE_VERTEX: 1
  CLOUD_ML_REGION: us-east5
  ANTHROPIC_VERTEX_PROJECT_ID: itpc-gcp-ai-eng-claude

Then restart your shell:
  exec fish" $GUM_SUCCESS
else
    # Disable Vertex AI
    subsection "Using standard Claude API"

    # Update chezmoi data file
    if not grep -q "^\[data\.claude\]" "$chezmoi_data" 2>/dev/null
        echo "" >> "$chezmoi_data"
        echo "[data.claude]" >> "$chezmoi_data"
    end

    # Remove old claude settings if they exist
    sed -i '/^\[data\.claude\]/,/^\[/{ /^\[data\.claude\]/!{ /^\[/!d; }; }' "$chezmoi_data"

    # Add setting
    sed -i "/^\[data\.claude\]/a\\  use_vertex = false" "$chezmoi_data"

    success "Standard API configured"
    echo ""
    box "Standard API Configuration

⚠️  Run 'chezmoi apply' to activate:
  chezmoi apply

Then authenticate with:
  claude auth login

Then restart your shell:
  exec fish" $GUM_SUCCESS
end

echo ""
{{- end }}
