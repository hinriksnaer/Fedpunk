{{- if ne .mode.name "container" -}}
#!/usr/bin/env fish
# Setup script for Claude Code authentication
# Prompts user to choose between standard API key or Google Vertex AI authentication
# Mode: {{ .mode.name }}

source "{{ .chezmoi.workingTree }}/home/install/lib/helpers.fish"

set chezmoi_data "$HOME/.config/chezmoi/chezmoi.toml"

section "Claude Code Authentication Setup"

# Require TTY for interactive prompts (or environment variable override)
require_tty "Claude Code Setup" "FEDPUNK_SETUP_CLAUDE=skip|apikey|vertex"

# Check current configuration
{{- if hasKey . "claude" }}
{{-   if hasKey .claude "auth_method" }}
set current_auth "{{ .claude.auth_method }}"
info "Current authentication method: $current_auth"
{{-   else }}
set current_auth "none"
info "No authentication configured yet"
{{-   end }}
{{- else }}
set current_auth "none"
info "No authentication configured yet"
{{- end }}

# Ask if user wants to configure
echo ""
set configure (gum choose \
    --header "Do you want to configure Claude Code authentication?" \
    --cursor.foreground="212" \
    "Yes" "No" \
    </dev/tty)

if test "$configure" = "No"
    echo ""
    info "Skipping Claude authentication setup"
    echo ""
    exit 0
end

# Prompt for authentication method
echo ""
set auth_method (gum choose \
    --header "Choose Claude Code authentication method:" \
    --cursor.foreground="212" \
    "Standard API Key" \
    "Google Vertex AI" \
    </dev/tty)

echo ""

if test "$auth_method" = "Google Vertex AI"
    subsection "Configuring Google Vertex AI authentication"

    # Prompt for Vertex AI configuration
    set project_id (gum input \
        --placeholder "Enter your GCP Project ID" \
        --value "{{ if and (hasKey . \"claude\") (hasKey .claude \"vertex_project_id\") }}{{ .claude.vertex_project_id }}{{ end }}" \
        </dev/tty)

    echo ""
    set region (gum input \
        --placeholder "Enter Vertex AI region (e.g., us-east5)" \
        --value "{{ if and (hasKey . \"claude\") (hasKey .claude \"vertex_region\") }}{{ .claude.vertex_region }}{{ else }}us-east5{{ end }}" \
        </dev/tty)

    echo ""
    if gum confirm "Do you want to specify a service account key file?" </dev/tty
        set key_file (gum input \
            --placeholder "Path to service account key JSON file (optional)" \
            --value "{{ if and (hasKey . \"claude\") (hasKey .claude \"vertex_key_file\") }}{{ .claude.vertex_key_file }}{{ end }}" \
            </dev/tty)
    else
        set key_file ""
    end

    # Validate inputs
    if test -z "$project_id"
        error "Project ID cannot be empty"
        exit 1
    end

    if test -z "$region"
        error "Region cannot be empty"
        exit 1
    end

    # Update chezmoi data file
    echo ""
    subsection "Saving configuration"

    # Create or update the [data.claude] section
    if not grep -q "^\[data\.claude\]" "$chezmoi_data" 2>/dev/null
        echo "" >> "$chezmoi_data"
        echo "[data.claude]" >> "$chezmoi_data"
    end

    # Remove old claude settings if they exist
    sed -i '/^\[data\.claude\]/,/^\[/{ /^\[data\.claude\]/!{ /^\[/!d; }; }' "$chezmoi_data"

    # Add new settings after [data.claude] marker
    sed -i "/^\[data\.claude\]/a\\  auth_method = \"vertex\"\\n  vertex_project_id = \"$project_id\"\\n  vertex_region = \"$region\"" "$chezmoi_data"

    if test -n "$key_file"
        sed -i "/vertex_region/a\\  vertex_key_file = \"$key_file\"" "$chezmoi_data"
    end

    success "Google Vertex AI configuration saved"
    echo ""
    box "Vertex AI Configuration Saved

Project ID: $project_id
Region: $region
$(test -n "$key_file"; and echo "Key file: $key_file")

⚠️  Run 'chezmoi apply' to apply the configuration:
  chezmoi apply

Then restart your shell:
  exec fish" $GUM_SUCCESS
else
    subsection "Configuring standard API key authentication"

    # Update chezmoi data file
    if not grep -q "^\[data\.claude\]" "$chezmoi_data" 2>/dev/null
        echo "" >> "$chezmoi_data"
        echo "[data.claude]" >> "$chezmoi_data"
    end

    # Remove old claude settings if they exist
    sed -i '/^\[data\.claude\]/,/^\[/{ /^\[data\.claude\]/!{ /^\[/!d; }; }' "$chezmoi_data"

    # Add auth method
    sed -i "/^\[data\.claude\]/a\\  auth_method = \"apikey\"" "$chezmoi_data"

    success "Standard API key authentication configured"
    echo ""
    box "API Key Configuration Saved

⚠️  Run 'chezmoi apply' to apply the configuration:
  chezmoi apply

Then authenticate with:
  claude auth login

Then restart your shell:
  exec fish" $GUM_SUCCESS
end

echo ""
{{- end }}
