#!/usr/bin/env fish
# ============================================================================
# POST-INSTALL: Final setup and package updates
# ============================================================================
# Purpose:
#   - Update all packages to catch COPR updates
#   - Display completion message
# Runs: After all files deployed and components installed
# ============================================================================

# Set up environment variables
set -gx FEDPUNK_MODE "{{ .mode.name }}"

# Source helpers
source "{{ .chezmoi.workingTree }}/home/install/lib/helpers.fish"

section "Post-Installation"

# Setup themes directory symlink
subsection "Setting up themes directory"
set fedpunk_dir "$HOME/.local/share/fedpunk"
set themes_src "{{ .chezmoi.workingTree }}/themes"

if not test -d "$fedpunk_dir"
    mkdir -p "$fedpunk_dir"
end

# Remove old themes directory/symlink if it exists
if test -e "$fedpunk_dir/themes"
    rm -rf "$fedpunk_dir/themes"
end

# Create symlink to themes in repo
if ln -sf "$themes_src" "$fedpunk_dir/themes"
    success "Themes directory linked to $themes_src"
else
    warning "Failed to link themes directory"
end

# Apply default theme on fresh install
subsection "Applying default theme"
set default_theme "ayu-mirage"
if test -f "$HOME/.local/bin/fedpunk-theme-set"
    if $HOME/.local/bin/fedpunk-theme-set "$default_theme" >/dev/null 2>&1
        success "Default theme applied: $default_theme"
    else
        warning "Failed to apply default theme"
    end
else
    warning "Theme setter not found, skipping theme application"
end

# Update packages to catch any COPR or repo updates
subsection "Checking for package updates"
step "Updating packages" "sudo dnf upgrade -qy --refresh"

echo ""
box "Installation Complete!

Mode: {{ .mode.name }}

Next steps:
  • Restart your shell: exec fish
  • Check logs: $FEDPUNK_LOG_FILE

For desktop modes:
  • Logout and select Hyprland from login screen
  • Super+Enter: Terminal
  • Super+D: App launcher
  • Super+Q: Close window" $GUM_SUCCESS

echo ""
