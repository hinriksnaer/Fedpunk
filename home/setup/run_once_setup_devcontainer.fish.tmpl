#!/usr/bin/env fish
# Setup Devcontainer CLI for use with Podman
# Note: Requires Node.js/npm (installed by fedpunk essentials)

# Source helper functions
if not set -q FEDPUNK_PATH
    set -gx FEDPUNK_PATH "{{ .chezmoi.sourceDir }}"
end
source "{{ .chezmoi.sourceDir }}/home/core/lib/helpers.fish"

section "Devcontainer CLI Setup"

# Skip in container mode (devcontainer CLI is for host system, not inside containers)
if test "$FEDPUNK_MODE" = "container"
    info "Skipping Devcontainer CLI setup in container mode"
    info "Devcontainer CLI should be installed on the host system, not inside containers"
    echo ""
    exit 0
end

subsection "Verifying prerequisites"

# Verify npm is available
if not command -v npm >/dev/null 2>&1
    error "npm not found. Please run fedpunk installation first."
    info "Node.js and npm are installed as part of fedpunk essentials."
    exit 1
end

success "npm found"

# Install devcontainer CLI globally
subsection "Installing @devcontainers/cli"
step "Installing devcontainer CLI" "sudo npm install -g @devcontainers/cli"

# Verify installation
if command -v devcontainer >/dev/null 2>&1
    success "Devcontainer CLI installed successfully!"
    devcontainer --version
else
    error "Failed to install devcontainer CLI"
    exit 1
end

echo ""
box "Devcontainer CLI Installed!

Usage:
  devcontainer up --workspace-folder .
  devcontainer exec --workspace-folder . fish

Or use aliases (after deploying fish config):
  dc-up         # Start container
  dc-exec fish  # Execute shell in container
  dc-rebuild    # Rebuild from scratch

Make sure Podman is running:
  systemctl --user start podman.socket" $GUM_SUCCESS
