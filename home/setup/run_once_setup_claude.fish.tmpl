#!/usr/bin/env fish
# Setup script for Claude Code authentication
# Prompts user to choose between standard API key or Google Vertex AI authentication

# Source helper functions
if not set -q FEDPUNK_PATH
    set -gx FEDPUNK_PATH "{{ .chezmoi.sourceDir }}"
end
source "{{ .chezmoi.sourceDir }}/home/core/lib/helpers.fish"

set config_file "$HOME/.config/fish/config.fish"

section "Claude Code Authentication Setup"

# Skip in container mode (authentication setup not useful in containers)
if test "$FEDPUNK_MODE" = "container"
    info "Skipping Claude Code authentication setup in container mode"
    info "Claude Code auth is typically not needed in container environments"
    echo ""
    exit 0
end

# Require TTY for interactive prompts (or environment variable override)
require_tty "Claude Code Setup" "FEDPUNK_SETUP_CLAUDE=skip|apikey|vertex"

# Check current status
set current_status "disabled"
if grep -q "^source.*claude-vertex.fish" "$config_file" 2>/dev/null
    set current_status "enabled"
end

info "Current status: Claude Vertex AI is $current_status"

# Ask if user wants to configure
echo ""
set configure (gum choose \
    --header "Do you want to configure Claude Code authentication?" \
    --cursor.foreground="212" \
    "Yes" "No" \
    </dev/tty)

if test "$configure" = "No"
    echo ""
    info "Skipping Claude authentication setup"
    echo ""
    exit 0
end

# Prompt for authentication method
echo ""
set auth_method (gum choose \
    --header "Choose Claude Code authentication method:" \
    --cursor.foreground="212" \
    "Standard API Key" \
    "Google Vertex AI" \
    </dev/tty)

echo ""

if test "$auth_method" = "Google Vertex AI"
    subsection "Enabling Google Vertex AI authentication"

    # Uncomment the source line
    sed -i 's/^# source (dirname (status --current-filename))\/claude-vertex.fish/source (dirname (status --current-filename))\/claude-vertex.fish/' "$config_file"

    success "Google Vertex AI authentication enabled"
    echo ""
    box "Vertex AI Configuration

Environment variables:
  CLAUDE_CODE_USE_VERTEX: 1
  CLOUD_ML_REGION: us-east5
  ANTHROPIC_VERTEX_PROJECT_ID: itpc-gcp-ai-eng-claude

⚠️  Restart your shell for changes to take effect:
  exec fish" $GUM_INFO
else
    subsection "Enabling standard API key authentication"

    # Comment out the source line
    sed -i 's/^source (dirname (status --current-filename))\/claude-vertex.fish/# source (dirname (status --current-filename))\/claude-vertex.fish/' "$config_file"

    success "Standard API key authentication enabled"
    echo ""
    box "API Key Configuration

Standard Claude API authentication is now enabled.

⚠️  Restart your shell for changes to take effect:
  exec fish" $GUM_INFO
end

echo ""
