#!/usr/bin/env fish
# Fedpunk Post-Installation Script
# Runs profile post-install scripts after deploying dotfiles

set -x FEDPUNK_PATH "{{ .chezmoi.workingTree }}"
set -x FEDPUNK_PROFILE_PATH "{{ .profile.path }}"
set -x FEDPUNK_MODE "{{ .mode.name }}"
set -x FEDPUNK_LOG_FILE "/tmp/fedpunk-post-install-"(date +%Y%m%d-%H%M%S)".log"

echo ""
echo "╔═══════════════════════════════════════════════════════╗"
echo "║                                                       ║"
echo "║          Phase 3: Post-Installation Setup             ║"
echo "║                                                       ║"
echo "╚═══════════════════════════════════════════════════════╝"
echo ""
echo "Configuration:"
echo "  Mode:    {{ .mode.name }}"
echo "  Profile: {{ .profile.name }}"
echo ""
echo "Log: $FEDPUNK_LOG_FILE"
echo "───────────────────────────────────────────────────────"
echo ""

# Create log file
echo "Fedpunk Post-Installation - "(date) > "$FEDPUNK_LOG_FILE"
echo "Mode: {{ .mode.name }}" >> "$FEDPUNK_LOG_FILE"
echo "Profile: {{ .profile.name }}" >> "$FEDPUNK_LOG_FILE"
echo "" >> "$FEDPUNK_LOG_FILE"

# Run profile post-install scripts if they exist
set post_install_dir "$FEDPUNK_PROFILE_PATH/post-install"
if test -d "$post_install_dir"
    echo "Running profile post-install scripts..."
    echo ""

    for script in (ls "$post_install_dir"/*.fish 2>/dev/null | sort)
        set script_name (basename "$script")
        echo "→ Running $script_name..."

        fish "$script" 2>&1 | tee -a "$FEDPUNK_LOG_FILE"

        if test $status -ne 0
            echo ""
            echo "WARNING: Post-install script failed: $script_name"
            echo "Check log: $FEDPUNK_LOG_FILE"
        end

        echo ""
    end

    echo "====================================================="
    echo "Post-installation complete"
    echo "Log file: $FEDPUNK_LOG_FILE"
    echo ""
else
    echo "No post-install scripts found in profile"
    echo ""
end
