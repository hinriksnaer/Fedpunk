#!/usr/bin/env fish
# Fedpunk Post-Installation Script
# Runs setup scripts after deploying dotfiles

set -x FEDPUNK_PATH "{{ .chezmoi.workingTree }}"
set -x FEDPUNK_MODE "{{ .mode.name }}"
set -x FEDPUNK_LOG_FILE "/tmp/fedpunk-post-install-"(date +%Y%m%d-%H%M%S)".log"

echo ""
echo "╔═══════════════════════════════════════════════════════╗"
echo "║                                                       ║"
echo "║          Phase 3: Post-Installation Setup             ║"
echo "║                                                       ║"
echo "╚═══════════════════════════════════════════════════════╝"
echo ""
echo "Configuration:"
echo "  Mode:    {{ .mode.name }}"
echo ""
echo "Log: $FEDPUNK_LOG_FILE"
echo "───────────────────────────────────────────────────────"
echo ""

# Create log file
echo "Fedpunk Post-Installation - "(date) > "$FEDPUNK_LOG_FILE"
echo "Mode: {{ .mode.name }}" >> "$FEDPUNK_LOG_FILE"
echo "" >> "$FEDPUNK_LOG_FILE"

# Run setup scripts if they exist
set scripts_dir "$FEDPUNK_PATH/home/scripts"
if test -d "$scripts_dir"
    echo "Running setup scripts..."
    echo ""

    for script in (ls "$scripts_dir"/setup-*.fish 2>/dev/null | sort)
        set script_name (basename "$script")
        echo "→ Running: $script_name"

        fish "$script" 2>&1 | tee -a "$FEDPUNK_LOG_FILE"

        if test $status -ne 0
            echo ""
            echo "✗ Executing $script_name failed (exit: $status)"
            echo ""
            echo "Error details:"
            tail -20 "$FEDPUNK_LOG_FILE" | grep -A 10 "ERROR\|error\|Error" || echo "  Check full log for details"
            echo ""
            echo "→ Full logs: $FEDPUNK_LOG_FILE"
            echo ""
            # Continue with other scripts instead of failing
        end

        echo ""
    end

    echo "====================================================="
    echo "Post-installation complete"
    echo "Log file: $FEDPUNK_LOG_FILE"
    echo ""
else
    echo "No setup scripts found"
    echo ""
end
