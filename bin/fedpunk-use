#!/usr/bin/env fish
# Switch to a different Fedpunk configuration
# Usage: fedpunk-use <config-path>

set FEDPUNK_ROOT "$HOME/.local/share/fedpunk"
set ACTIVE_CONFIG_LINK "$FEDPUNK_ROOT/.active-config"

function show_usage
    echo "Usage: fedpunk-use <config-path>"
    echo ""
    echo "Switch to a different Fedpunk configuration"
    echo ""
    echo "Arguments:"
    echo "  <config-path>    Path to config directory (absolute or relative)"
    echo "                   Can also use shortcuts:"
    echo "                   - 'default'      → profiles/default"
    echo "                   - 'minimal'      → profiles/minimal"
    echo "                   - 'terminal-only' → profiles/terminal-only"
    echo "                   - 'gaming'       → profiles/gaming"
    echo "                   - 'custom'       → custom/"
    echo ""
    echo "Examples:"
    echo "  fedpunk-use default                    # Use default config"
    echo "  fedpunk-use custom                     # Use your custom config"
    echo "  fedpunk-use ~/my-profiles/work         # Use external config"
    echo "  fedpunk-use ~/.config/fedpunk-gaming   # Use config from anywhere"
    echo ""
    echo "Current active config:"
    if test -L "$ACTIVE_CONFIG_LINK"
        set current (readlink "$ACTIVE_CONFIG_LINK")
        echo "  → $current"
    else
        echo "  → None (not yet configured)"
    end
end

function validate_config
    set config_dir $argv[1]

    if not test -d "$config_dir"
        echo "Error: Config directory not found: $config_dir" >&2
        return 1
    end

    if not test -f "$config_dir/fedpunk.toml"
        echo "Error: Invalid config directory (missing fedpunk.toml): $config_dir" >&2
        echo "" >&2
        echo "A valid Fedpunk config must have a fedpunk.toml file." >&2
        echo "Create one with: fedpunk-config-create" >&2
        return 1
    end

    return 0
end

function resolve_config_path
    set input $argv[1]

    # Handle shortcuts
    switch $input
        case default minimal terminal-only gaming
            echo "$FEDPUNK_ROOT/profiles/$input"
            return 0
        case custom
            echo "$FEDPUNK_ROOT/custom"
            return 0
    end

    # Handle relative/absolute paths
    if string match -q '/*' -- "$input"
        # Already absolute
        echo "$input"
    else
        # Make absolute from current directory
        echo (realpath "$input" 2>/dev/null; or echo "$input")
    end
end

function switch_config
    set config_dir $argv[1]

    # Remove old symlink if exists
    if test -L "$ACTIVE_CONFIG_LINK" -o -e "$ACTIVE_CONFIG_LINK"
        rm -f "$ACTIVE_CONFIG_LINK"
    end

    # Create new symlink
    ln -s "$config_dir" "$ACTIVE_CONFIG_LINK"

    if test $status -ne 0
        echo "Error: Failed to create symlink to $config_dir" >&2
        return 1
    end

    return 0
end

function get_config_name
    set config_dir $argv[1]

    if test -f "$config_dir/fedpunk.toml"
        # Try to extract name from TOML
        set name_line (grep '^name = ' "$config_dir/fedpunk.toml" | head -n 1)
        if test -n "$name_line"
            echo $name_line | sed 's/^name = "\(.*\)"/\1/'
            return 0
        end
    end

    # Fallback to directory name
    basename "$config_dir"
end

function show_config_info
    set config_dir $argv[1]
    set config_name (get_config_name "$config_dir")

    echo ""
    echo "✓ Switched to config: $config_name"
    echo "  Location: $config_dir"

    # Show what's included
    if test -f "$config_dir/fedpunk.toml"
        echo ""
        echo "  Components:"
        test -d "$config_dir/themes"; and echo "    • Themes"
        test -d "$config_dir/scripts"; and echo "    • Scripts"
        test -d "$config_dir/config"; and echo "    • Dotfiles"
        test -f "$config_dir/config.fish"; and echo "    • Fish config"
        test -f "$config_dir/keybinds.conf"; and echo "    • Hyprland keybinds"
    end

    echo ""
    echo "  To apply changes:"
    echo "    • Restart your terminal (or: exec fish)"
    if command -v hyprctl >/dev/null 2>&1
        echo "    • Reload Hyprland: hyprctl reload"
    end
    echo ""
end

# Main script
if test (count $argv) -eq 0
    show_usage
    exit 0
end

if test "$argv[1]" = "--help" -o "$argv[1]" = "-h"
    show_usage
    exit 0
end

# Resolve config path
set config_path (resolve_config_path $argv[1])

# Validate config
validate_config "$config_path"; or exit 1

# Switch to config
if switch_config "$config_path"
    show_config_info "$config_path"
    exit 0
else
    echo "Failed to switch config" >&2
    exit 1
end
