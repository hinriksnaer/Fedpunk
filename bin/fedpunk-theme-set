#!/usr/bin/env fish
# Set a specific theme by name
# Usage: fedpunk-theme-set <theme-name>

if test (count $argv) -lt 1
    echo "Usage: fedpunk-theme-set <theme-name>"
    echo ""
    echo "Available themes:"
    fedpunk-theme-list
    exit 1
end

set themes_dir "$HOME/.local/share/fedpunk/themes"
set hyprland_conf "$HOME/.config/hypr/hyprland.conf"

# Normalize theme name (lowercase, convert spaces to dashes)
set theme_name (echo $argv[1] | string lower | string replace -a ' ' '-')
set theme_path "$themes_dir/$theme_name"

# Check if theme exists
if not test -d "$theme_path"
    echo "Error: Theme '$theme_name' does not exist"
    echo ""
    echo "Available themes:"
    fedpunk-theme-list
    exit 1
end

echo "Switching to theme: $theme_name"
echo ""

set applied_count 0
set skipped_count 0

# Update Hyprland config to source the theme's hyprland.conf
if test -f "$theme_path/hyprland.conf"
    # Replace the source line in hyprland.conf
    sed -i "s|^source = \$HOME/.*themes/.*/hyprland.conf|source = \$HOME/.local/share/fedpunk/themes/$theme_name/hyprland.conf|" $hyprland_conf
    echo "✓ Updated Hyprland theme source"
    set applied_count (math $applied_count + 1)
else
    echo "⊘ Skipped hyprland.conf (not found in theme)"
    set skipped_count (math $skipped_count + 1)
end

# Theme file mappings: source -> destination (symlinks)
# Format: primary_file|fallback_file:destination_path
set -l theme_mappings \
    "kitty.conf:$HOME/.config/kitty/theme.conf" \
    ".fedpunk-foot.ini|foot.ini:$HOME/.config/foot/theme.ini" \
    "walker.css:$HOME/.config/walker/theme.css" \
    "btop.theme:$HOME/.config/btop/themes/active.theme"

# Apply other theme files (symlinks)
for mapping in $theme_mappings
    set parts (string split ":" $mapping)
    set source_files $parts[1]
    set dest_path $parts[2]

    # Check for primary file first, then fallback(s)
    set source_path ""
    set used_file ""
    for candidate in (string split "|" $source_files)
        if test -f "$theme_path/$candidate"
            set source_path "$theme_path/$candidate"
            set used_file $candidate
            break
        end
    end

    if test -n "$source_path"
        # Create destination directory if needed
        set dest_dir (dirname $dest_path)
        mkdir -p $dest_dir 2>/dev/null

        # Create symlink
        ln -sf $source_path $dest_path
        set applied_count (math $applied_count + 1)
        echo "✓ Applied $used_file"
    else
        set skipped_count (math $skipped_count + 1)
        set first_candidate (string split "|" $source_files)[1]
        echo "⊘ Skipped $first_candidate (not found in theme)"
    end
end

# Set wallpaper from theme
echo ""
fedpunk-wallpaper-set $theme_name

# Reload applications
echo ""
echo "Reloading applications..."

# Reload Hyprland
if hyprctl reload >/dev/null 2>&1
    echo "✓ Hyprland reloaded"
else
    echo "✗ Hyprland reload failed"
end

# Reload btop if running
if pgrep -x btop >/dev/null 2>&1
    pkill -SIGUSR2 btop 2>/dev/null
    and echo "✓ btop reloaded"
end

# Note: Kitty doesn't support live theme reloading
# New kitty instances will pick up the theme automatically
if pgrep -x kitty >/dev/null 2>&1
    echo "⟳ kitty will update on next launch (restart kitty to see changes)"
end

# Restart walker if running (to apply theme immediately)
if pgrep -x walker >/dev/null 2>&1
    pkill walker 2>/dev/null
    and echo "✓ Walker restarted (will auto-launch on next use)"
end

# Note: Terminal emulators pick up theme changes on next launch
if not pgrep -x kitty >/dev/null 2>&1
    echo "⟳ Terminal emulators will update on next launch"
end

# Send notification
set pretty_name (echo $theme_name | sed 's/-/ /g; s/\b\(.\)/\u\1/g')
notify-send "Theme Changed" "Switched to: $pretty_name\n$applied_count files applied, $skipped_count skipped" -t 3000

echo ""
echo "Theme switched to: $pretty_name"
echo "Applied $applied_count file(s), skipped $skipped_count"
