#!/usr/bin/env fish
# SSH Clusters - Configure usernames for internal clusters
# Generates User directives based on username_mode parameter

# Source UI library for consistent messaging
set -l lib_dir "$FEDPUNK_ROOT/lib/fish"
if test -f "$lib_dir/ui.fish"
    source "$lib_dir/ui.fish"
end

set -l hosts_file "$HOME/.ssh/config.d/hosts"
set -l users_file "$HOME/.ssh/config.d/hosts-users"

# Ensure directory exists
mkdir -p (dirname "$users_file")

# Get parameter values
set -l username_mode $FEDPUNK_PARAM_SSH_CLUSTERS_USERNAME_MODE
set -l param_username $FEDPUNK_PARAM_SSH_CLUSTERS_USERNAME

# Default to 'current' mode if not set
if test -z "$username_mode"
    set username_mode "current"
end

echo ""
echo "SSH Clusters - User Configuration"
echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
echo ""

# Define our clusters
set -l clusters eaglestream ibm-yugi ibm-kaiba ibm-joey

echo "Configuring "(count $clusters)" cluster(s): "(string join ", " $clusters)
echo "Username mode: $username_mode"
echo ""

# Determine username based on mode
set -l username_to_use ""

switch "$username_mode"
    case "current"
        set username_to_use (whoami)
        echo "Using current username: $username_to_use"

    case "declarative"
        if test -z "$param_username"
            echo "✗ Error: username_mode is 'declarative' but no username parameter set"
            echo "  Add username parameter to your fedpunk.yaml:"
            echo "  modules:"
            echo "    enabled:"
            echo "      - module: ssh-clusters"
            echo "        params:"
            echo "          username: yourname"
            exit 1
        end
        set username_to_use "$param_username"
        echo "Using declarative username: $username_to_use"

    case "prompt_all"
        # Prompt once for all clusters
        set -l default_user (whoami)
        if test -n "$param_username"
            set default_user "$param_username"
        end

        if command -v gum >/dev/null 2>&1
            set username_to_use (gum input --prompt "Username for all clusters: " --value "$default_user")
        else
            read -l -P "Username for all clusters [$default_user]: " username_to_use
            if test -z "$username_to_use"
                set username_to_use "$default_user"
            end
        end

        if test -z "$username_to_use"
            echo "✗ Error: No username provided"
            exit 1
        end
        echo "Using username: $username_to_use"

    case "prompt_individual"
        echo "Prompting for username per cluster..."

    case "*"
        echo "✗ Error: Unknown username_mode: $username_mode"
        exit 1
end

echo ""

# Generate users configuration file
set -l config_lines
set -a config_lines "# SSH Cluster User Configurations"
set -a config_lines "# Auto-generated by ssh-clusters module - DO NOT EDIT MANUALLY"
set -a config_lines "# Regenerate with: fedpunk module deploy ssh-clusters"
set -a config_lines "# Or modify parameters in ~/.config/fedpunk/fedpunk.yaml"
set -a config_lines ""

for cluster in $clusters
    if test "$username_mode" = "prompt_individual"
        set -l default_user (whoami)
        if test -n "$param_username"
            set default_user "$param_username"
        end

        set -l user_for_cluster ""
        if command -v gum >/dev/null 2>&1
            set user_for_cluster (gum input --prompt "Username for '$cluster': " --value "$default_user")
        else
            read -l -P "Username for '$cluster' [$default_user]: " user_for_cluster
            if test -z "$user_for_cluster"
                set user_for_cluster "$default_user"
            end
        end

        if test -z "$user_for_cluster"
            set user_for_cluster (whoami)
        end

        set -a config_lines "Match host $cluster"
        set -a config_lines "    User $user_for_cluster"
        set -a config_lines ""
    else
        set -a config_lines "Match host $cluster"
        set -a config_lines "    User $username_to_use"
        set -a config_lines ""
    end
end

# Write the users file
printf "%s\n" $config_lines > "$users_file"

echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
echo "✓ SSH cluster user configuration created: $users_file"
echo ""
echo "Configured clusters:"
for cluster in $clusters
    echo "  • $cluster"
end
echo ""
echo "To update usernames, modify parameters in ~/.config/fedpunk/fedpunk.yaml"
echo "and run: fedpunk module deploy ssh-clusters"
