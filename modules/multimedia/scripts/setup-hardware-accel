#!/usr/bin/env fish
# Setup hardware video acceleration

source "$FEDPUNK_ROOT/lib/fish/ui.fish"

ui-info "Setting up hardware video acceleration"

# Install multimedia groups
ui-spin --title "Installing multimedia group..." -- fish -c '
    sudo dnf group install -qy multimedia >/dev/null 2>&1
'

if test $status -eq 0
    ui-success "Multimedia group installed"
else
    ui-info "Multimedia group may already be installed"
end

# Swap ffmpeg-free with full ffmpeg
ui-spin --title "Installing full FFmpeg..." -- fish -c '
    sudo dnf swap -qy --allowerasing ffmpeg-free ffmpeg >/dev/null 2>&1
'

if test $status -eq 0
    ui-success "Full FFmpeg installed"
else
    ui-info "Full FFmpeg may already be installed"
end

# Install sound and video group
ui-spin --title "Installing sound-and-video group..." -- fish -c '
    sudo dnf group install -qy sound-and-video >/dev/null 2>&1
'

if test $status -eq 0
    ui-success "Sound and video packages installed"
else
    ui-info "Sound and video packages may already be installed"
end

# Upgrade multimedia stack
ui-spin --title "Upgrading multimedia stack..." -- fish -c '
    sudo dnf upgrade -qy @multimedia --setopt="install_weak_deps=False" >/dev/null 2>&1
'

if test $status -eq 0
    ui-success "Multimedia stack upgraded"
else
    ui-info "Multimedia stack already up to date"
end

# Detect and install GPU-specific drivers
ui-info "Detecting GPU for hardware acceleration"

if lspci | grep -i "VGA.*Intel" >/dev/null 2>&1
    ui-info "Intel GPU detected"
    ui-spin --title "Installing Intel media driver..." -- fish -c '
        sudo dnf swap -qy --allowerasing libva-intel-media-driver intel-media-driver >/dev/null 2>&1
    '

    if test $status -eq 0
        ui-success "Intel media driver installed"
    else
        ui-info "Intel media driver may already be installed"
    end
else if lspci | grep -i "VGA.*AMD\|VGA.*Radeon" >/dev/null 2>&1
    ui-info "AMD GPU detected"
    ui-spin --title "Installing AMD freeworld drivers..." -- fish -c '
        sudo dnf swap -qy --allowerasing mesa-va-drivers mesa-va-drivers-freeworld >/dev/null 2>&1
        sudo dnf swap -qy --allowerasing mesa-vdpau-drivers mesa-vdpau-drivers-freeworld >/dev/null 2>&1
    '

    if test $status -eq 0
        ui-success "AMD freeworld drivers installed"
    else
        ui-info "AMD drivers may already be installed"
    end
else
    ui-info "No Intel or AMD GPU detected, using generic drivers"
end

ui-success "Hardware acceleration setup complete"
