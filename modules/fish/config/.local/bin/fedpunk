#!/usr/bin/env fish
# Fedpunk CLI - Unified command-line interface
# Usage: fedpunk <command> [args...]

set script_dir (dirname (status -f))

# Help function
function show_help
    echo "Fedpunk CLI - Modern Fedora development environment"
    echo ""
    echo "Usage: fedpunk <command> [args...]"
    echo ""
    echo "Setup:"
    echo "  init                   Interactive setup wizard (TUI)"
    echo ""
    echo "Profile Management:"
    echo "  profile list           List available profiles (CLI)"
    echo "  profile select         Select profile interactively (TUI)"
    echo "  profile activate <name> Activate a profile (CLI)"
    echo "  profile current        Show active profile (CLI)"
    echo "  profile create [name]  Create new profile (TUI)"
    echo ""
    echo "Theme Management:"
    echo "  theme set <name>       Switch to a theme"
    echo "  theme list             List available themes"
    echo "  theme current          Show current theme"
    echo "  theme select           Interactive theme selector (fzf)"
    echo "  theme next             Switch to next theme"
    echo "  theme prev             Switch to previous theme"
    echo "  theme refresh          Refresh current theme"
    echo ""
    echo "Module Management:"
    echo "  module list            List available modules"
    echo "  module info <name>     Show module details"
    echo "  module deploy <name>   Deploy a module"
    echo "  module remove <name>   Remove a module"
    echo "  module status          Show deployed modules"
    echo ""
    echo "Wallpaper Management (Desktop):"
    echo "  wallpaper set <theme>  Set wallpaper from theme"
    echo "  wallpaper next         Switch to next wallpaper"
    echo ""
    echo "Vault Management (Bitwarden):"
    echo "  vault status           Show vault status"
    echo "  vault unlock           Unlock Bitwarden vault"
    echo "  vault ssh-backup       Backup SSH keys to vault"
    echo "  vault ssh-restore      Restore SSH keys from vault"
    echo "  vault claude-backup    Backup Claude Code token (no re-login needed!)"
    echo "  vault claude-restore   Restore Claude Code token on fresh install"
    echo ""
    echo "Configuration Management:"
    echo "  apply                  Apply current configuration (no git pull)"
    echo "  sync                   Pull latest changes and apply configs"
    echo ""
    echo "Other Commands:"
    echo "  bluetooth              Bluetooth manager (bluetui)"
    echo "  help                   Show this help message"
    echo "  version                Show version information"
    echo ""
    echo "Examples:"
    echo "  fedpunk init                    # Interactive setup (TUI)"
    echo "  fedpunk profile select          # Select profile (TUI)"
    echo "  fedpunk theme set nord          # Set theme (CLI)"
    echo "  fedpunk vault ssh-backup        # Backup SSH keys"
    echo "  fedpunk apply                   # Apply local config changes"
    echo "  fedpunk sync                    # Sync config across machines"
    echo ""
    echo "Get more info:"
    echo "  fedpunk <command> --help        # Show detailed help for a command"
end

# Show help if no arguments
if test (count $argv) -eq 0
    show_help
    exit 0
end

# Check for --help or -h flag
if contains -- --help $argv; or contains -- -h $argv
    show_help
    exit 0
end

set command $argv[1]
set args $argv[2..-1]

switch $command
    case init
        # Interactive setup wizard (TUI)
        if not command -v gum >/dev/null 2>&1
            echo "Error: gum is required for TUI mode"
            echo "Install with: sudo dnf install gum"
            exit 1
        end

        echo ""
        gum style --border rounded --padding "1 2" --border-foreground 33 "Fedpunk Setup Wizard"
        echo ""

        # Main menu
        set choice (gum choose --header "What would you like to do?" \
            "Create a new profile" \
            "Activate an existing profile" \
            "Configure git settings" \
            "Exit")

        switch $choice
            case "Create a new profile"
                exec $script_dir/fedpunk profile create

            case "Activate an existing profile"
                exec $script_dir/fedpunk profile select

            case "Configure git settings"
                # Interactive git configuration
                echo ""
                echo "Git Configuration"
                echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
                echo ""

                # Get current git config if it exists
                set current_name (git config --global user.name 2>/dev/null; or echo "")
                set current_email (git config --global user.email 2>/dev/null; or echo "")

                set git_name (gum input --placeholder "Your name" --value "$current_name")
                set git_email (gum input --placeholder "Your email" --value "$current_email")

                if test -n "$git_name"
                    git config --global user.name "$git_name"
                    echo "âœ“ Set git user.name = $git_name"
                end

                if test -n "$git_email"
                    git config --global user.email "$git_email"
                    echo "âœ“ Set git user.email = $git_email"
                end

                echo ""
                echo "Git configuration updated!"

            case "Exit"
                echo "Goodbye!"
                exit 0
        end

    case profile
        # Profile subcommands
        if test (count $args) -eq 0
            echo "Usage: fedpunk profile <subcommand> [args...]"
            echo ""
            echo "Subcommands:"
            echo "  list              List available profiles (CLI)"
            echo "  select            Select a profile interactively (TUI)"
            echo "  activate <name>   Activate a profile (CLI)"
            echo "  current           Show active profile (CLI)"
            echo "  create <name>     Create new profile from template (TUI)"
            echo ""
            echo "Examples:"
            echo "  fedpunk profile select              # TUI mode"
            echo "  fedpunk profile activate dev        # CLI mode"
            echo "  fedpunk profile create myprofile    # TUI mode"
            exit 1
        end

        set profile_cmd $args[1]
        set profile_args $args[2..-1]

        switch $profile_cmd
            case activate
                exec $script_dir/fedpunk-activate-profile $profile_args

            case select
                # TUI mode - interactive profile selector
                if not command -v gum >/dev/null 2>&1
                    echo "Error: gum is required for TUI mode"
                    echo "Install with: sudo dnf install gum"
                    exit 1
                end

                set profiles_dir "$HOME/.local/share/fedpunk/profiles"
                if not test -d "$profiles_dir"
                    echo "No profiles directory found"
                    exit 1
                end

                # Get list of profiles
                set profiles (find "$profiles_dir" -maxdepth 1 -mindepth 1 -type d -exec basename {} \; | sort)

                if test (count $profiles) -eq 0
                    echo "No profiles found"
                    exit 1
                end

                # Get current profile for display
                set current_profile ""
                if test -L "$HOME/.local/share/fedpunk/.active-config"
                    set current_profile (basename (readlink "$HOME/.local/share/fedpunk/.active-config"))
                end

                # Build display list with markers
                set display_list
                for profile in $profiles
                    if test "$profile" = "$current_profile"
                        set display_list $display_list "$profile (active)"
                    else
                        set display_list $display_list "$profile"
                    end
                end

                # Show interactive selector
                set selected (gum choose --header "Select a profile to activate:" $display_list)

                if test -z "$selected"
                    echo "No profile selected"
                    exit 0
                end

                # Remove " (active)" marker if present
                set profile_name (echo $selected | sed 's/ (active)//')

                # Activate the selected profile
                exec $script_dir/fedpunk-activate-profile $profile_name

            case list
                # List available profiles (CLI mode)
                set profiles_dir "$HOME/.local/share/fedpunk/profiles"
                if test -d "$profiles_dir"
                    echo "Available profiles:"
                    for profile in (find "$profiles_dir" -maxdepth 1 -mindepth 1 -type d -exec basename {} \; | sort)
                        # Check if it's the active profile
                        set active_marker ""
                        if test -L "$HOME/.local/share/fedpunk/.active-config"
                            set active_profile (basename (readlink "$HOME/.local/share/fedpunk/.active-config"))
                            if test "$profile" = "$active_profile"
                                set active_marker " (active)"
                            end
                        end
                        echo "  â€¢ $profile$active_marker"
                    end
                else
                    echo "No profiles directory found"
                    exit 1
                end

            case current
                # Show current active profile (CLI mode)
                if test -L "$HOME/.local/share/fedpunk/.active-config"
                    set active_profile (basename (readlink "$HOME/.local/share/fedpunk/.active-config"))
                    echo "Active profile: $active_profile"
                else
                    echo "No active profile (no .active-config symlink)"
                    exit 1
                end

            case create
                # TUI mode - create new profile from template
                if not command -v gum >/dev/null 2>&1
                    echo "Error: gum is required for TUI mode"
                    echo "Install with: sudo dnf install gum"
                    exit 1
                end

                # Get profile name
                set new_profile_name $profile_args[1]
                if test -z "$new_profile_name"
                    set new_profile_name (gum input --placeholder "Enter new profile name (e.g., myprofile)")
                end

                if test -z "$new_profile_name"
                    echo "Profile name is required"
                    exit 1
                end

                set profiles_dir "$HOME/.local/share/fedpunk/profiles"
                set new_profile_path "$profiles_dir/$new_profile_name"

                # Check if profile already exists
                if test -d "$new_profile_path"
                    echo "Error: Profile '$new_profile_name' already exists"
                    exit 1
                end

                # Ask which template to use
                set template (gum choose --header "Select template to copy from:" "example" "dev")

                if test -z "$template"
                    echo "No template selected"
                    exit 0
                end

                # Copy template
                echo "Creating profile '$new_profile_name' from template '$template'..."
                cp -r "$profiles_dir/$template" "$new_profile_path"

                # Update fedpunk.toml metadata
                if test -f "$new_profile_path/fedpunk.toml"
                    # Prompt for profile metadata
                    set profile_desc (gum input --placeholder "Profile description" --value "My custom Fedpunk profile")
                    set profile_author (gum input --placeholder "Author name" --value (whoami))

                    # Update TOML file
                    sed -i "s/^name = .*/name = \"$new_profile_name\"/" "$new_profile_path/fedpunk.toml"
                    sed -i "s/^description = .*/description = \"$profile_desc\"/" "$new_profile_path/fedpunk.toml"
                    sed -i "s/^author = .*/author = \"$profile_author\"/" "$new_profile_path/fedpunk.toml"
                end

                echo "âœ“ Profile created: $new_profile_path"
                echo ""

                # Ask if they want to activate it now
                if gum confirm "Activate this profile now?"
                    exec $script_dir/fedpunk-activate-profile $new_profile_name
                else
                    echo "Profile created but not activated."
                    echo "To activate later, run: fedpunk profile activate $new_profile_name"
                end

            case '*'
                echo "Unknown profile subcommand: $profile_cmd"
                echo "Run 'fedpunk profile' for help"
                exit 1
        end

    case theme
        # Theme subcommands
        if test (count $args) -eq 0
            echo "Usage: fedpunk theme <subcommand> [args...]"
            echo ""
            echo "Subcommands:"
            echo "  set <name>     Switch to a theme"
            echo "  list           List available themes"
            echo "  current        Show current theme"
            echo "  select         Interactive theme selector"
            echo "  next           Switch to next theme"
            echo "  prev           Switch to previous theme"
            echo "  refresh        Refresh current theme"
            exit 1
        end

        set theme_cmd $args[1]
        set theme_args $args[2..-1]

        switch $theme_cmd
            case set
                exec $script_dir/fedpunk-theme-set $theme_args
            case list
                exec $script_dir/fedpunk-theme-list
            case current
                exec $script_dir/fedpunk-theme-current
            case select
                exec $script_dir/fedpunk-theme-select-cli
            case next
                exec $script_dir/fedpunk-theme-next
            case prev
                exec $script_dir/fedpunk-theme-prev
            case refresh
                exec $script_dir/fedpunk-theme-refresh
            case '*'
                echo "Unknown theme subcommand: $theme_cmd"
                echo "Run 'fedpunk theme' for help"
                exit 1
        end

    case wallpaper
        # Wallpaper subcommands (desktop only)
        if test (count $args) -eq 0
            echo "Usage: fedpunk wallpaper <subcommand> [args...]"
            echo ""
            echo "Subcommands:"
            echo "  set <theme>    Set wallpaper from theme"
            echo "  next           Switch to next wallpaper"
            exit 1
        end

        set wallpaper_cmd $args[1]
        set wallpaper_args $args[2..-1]

        switch $wallpaper_cmd
            case set
                exec $script_dir/fedpunk-wallpaper-set $wallpaper_args
            case next
                exec $script_dir/fedpunk-wallpaper-next
            case '*'
                echo "Unknown wallpaper subcommand: $wallpaper_cmd"
                echo "Run 'fedpunk wallpaper' for help"
                exit 1
        end

    case module
        # Module management
        if test (count $args) -eq 0
            echo "Usage: fedpunk module <subcommand> [args...]"
            echo ""
            echo "Subcommands:"
            echo "  list              List available modules"
            echo "  info <name>       Show module information"
            echo "  deploy <name>     Deploy a module (packages + config + lifecycle)"
            echo "  remove <name>     Remove a module (unstow config)"
            echo "  status            Show deployed modules"
            echo ""
            echo "Examples:"
            echo "  fedpunk module list"
            echo "  fedpunk module info fish"
            echo "  fedpunk module deploy hyprland"
            exit 1
        end

        set module_cmd $args[1]
        set module_args $args[2..-1]

        # Set FEDPUNK_ROOT if not set
        if not set -q FEDPUNK_ROOT
            if test -L ~/.local/share/fedpunk
                set -gx FEDPUNK_ROOT (readlink -f ~/.local/share/fedpunk)
            else if test -d ~/.local/share/fedpunk
                set -gx FEDPUNK_ROOT ~/.local/share/fedpunk
            else
                echo "Error: FEDPUNK_ROOT not found" >&2
                exit 1
            end
        end

        # Source module library
        source "$FEDPUNK_ROOT/lib/fish/fedpunk-module.fish"

        switch $module_cmd
            case list
                fedpunk-module list
            case info
                if test (count $module_args) -eq 0
                    echo "Error: module name required"
                    echo "Usage: fedpunk module info <name>"
                    exit 1
                end
                fedpunk-module info $module_args
            case deploy
                if test (count $module_args) -eq 0
                    echo "Error: module name required"
                    echo "Usage: fedpunk module deploy <name>"
                    exit 1
                end
                fedpunk-module deploy $module_args
            case remove unstow
                if test (count $module_args) -eq 0
                    echo "Error: module name required"
                    echo "Usage: fedpunk module remove <name>"
                    exit 1
                end
                fedpunk-module unstow $module_args
            case status
                # Show deployed modules from linker state
                if test -f "$FEDPUNK_ROOT/.linker-state.json"
                    source "$FEDPUNK_ROOT/lib/fish/linker.fish"
                    linker-status
                else
                    echo "No deployment state found (using stow)"
                    echo "Module status tracking requires the new linker"
                end
            case '*'
                echo "Unknown module subcommand: $module_cmd"
                echo "Run 'fedpunk module' for help"
                exit 1
        end

    case vault
        # Bitwarden vault management
        if not command -v bw >/dev/null 2>&1
            echo "Error: Bitwarden CLI not installed"
            echo "Install with: sudo dnf install bw"
            exit 1
        end

        if test (count $args) -eq 0
            echo "Usage: fedpunk vault <subcommand> [args...]"
            echo ""
            echo "Subcommands:"
            echo "  status           Show vault status"
            echo "  login            Login to Bitwarden"
            echo "  unlock           Unlock the vault"
            echo "  lock             Lock the vault"
            echo "  sync             Sync vault with server"
            echo "  get <name>       Get password for item"
            echo "  ssh-load           Load SSH keys into agent"
            echo "  ssh-backup [name]  Backup ~/.ssh directory to vault"
            echo "  ssh-restore [name] Restore ~/.ssh directory from vault"
            echo "  claude-backup [name]  Generate & backup Claude Code long-lived token"
            echo "  claude-restore [name] Restore Claude Code token (no login needed!)"
            echo "  env <name>         Load environment variables from item"
            echo ""
            echo "Examples:"
            echo "  fedpunk vault unlock"
            echo "  fedpunk vault get github"
            echo "  fedpunk vault ssh-backup                    # Default backup"
            echo "  fedpunk vault ssh-backup work-laptop        # Named backup"
            echo "  fedpunk vault ssh-restore                   # Restore default"
            echo "  fedpunk vault ssh-restore work-laptop       # Restore named"
            echo "  fedpunk vault claude-backup                 # Generate long-lived token"
            echo "  fedpunk vault claude-restore                # Restore on fresh install"
            exit 1
        end

        set vault_cmd $args[1]
        set vault_args $args[2..-1]

        switch $vault_cmd
            case status
                bw status | fish -c 'read -z input; echo $input | jq .'

            case login
                bwlogin

            case unlock
                bwunlock

            case lock
                bw lock

            case sync
                if not bw sync
                    echo "Error: Failed to sync vault"
                    exit 1
                end
                echo "âœ“ Vault synced successfully"

            case get
                if test (count $vault_args) -eq 0
                    echo "Error: Item name required"
                    echo "Usage: fedpunk vault get <name>"
                    exit 1
                end
                bw-get $vault_args

            case ssh-load
                bw-ssh-load

            case ssh-backup
                # Backup ~/.ssh directory to Bitwarden
                echo "ðŸ”’ Backing up SSH configuration to Bitwarden..."
                echo ""

                # Check if SSH directory exists
                if not test -d "$HOME/.ssh"
                    echo "âœ— No ~/.ssh directory found"
                    exit 1
                end

                # Check if vault is unlocked
                set bw_status (bw status 2>/dev/null | grep -o '"status":"[^"]*"' | cut -d'"' -f4)
                if test "$bw_status" != "unlocked"
                    echo "âœ— Bitwarden vault is locked"
                    echo "  Run: fedpunk vault unlock"
                    exit 1
                end

                # Get backup name (optional)
                if test (count $vault_args) -gt 0
                    set backup_name $vault_args[1]
                    set item_name "SSH Config - $backup_name"
                else
                    set item_name "SSH Configuration Backup"
                end

                echo "Backup name: $item_name"
                echo ""

                # Create a tarball of .ssh directory (excluding known_hosts)
                set backup_file (mktemp --suffix=.tar.gz)
                echo "â†’ Creating encrypted backup..."
                echo "  (excluding known_hosts - will be rebuilt automatically)"
                tar -czf "$backup_file" -C "$HOME" --exclude='.ssh/known_hosts' --exclude='.ssh/known_hosts.old' .ssh 2>/dev/null

                if not test -f "$backup_file"
                    echo "âœ— Failed to create backup"
                    exit 1
                end

                # Base64 encode the tarball
                set encoded_backup (base64 -w 0 "$backup_file")
                rm -f "$backup_file"

                # Setup metadata
                set backup_hostname (hostname)
                set timestamp (date -u +"%Y-%m-%dT%H:%M:%SZ")

                # Check if item exists
                set existing_item (bw get item "$item_name" 2>/dev/null)

                # Prepare note content
                set note_content "SSH Configuration Backup
Hostname: $backup_hostname
Timestamp: $timestamp
Format: tar.gz (base64 encoded)

--- BEGIN SSH BACKUP ---
$encoded_backup
--- END SSH BACKUP ---"

                if test -n "$existing_item"
                    # Update existing item
                    echo "â†’ Updating existing backup..."
                    set item_id (echo "$existing_item" | jq -r '.id')

                    # Update item
                    echo "$existing_item" | jq --arg notes "$note_content" '.notes = $notes' | bw encode | bw edit item "$item_id" >/dev/null 2>&1
                    set bw_status $status
                else
                    # Create new item
                    echo "â†’ Creating new backup item..."

                    # Create secure note using jq for proper JSON encoding
                    jq -n --arg name "$item_name" --arg notes "$note_content" '{
  organizationId: null,
  folderId: null,
  type: 2,
  name: $name,
  notes: $notes,
  favorite: false,
  secureNote: {
    type: 0
  }
}' | bw encode | bw create item >/dev/null 2>&1
                    set bw_status $status
                end

                if test $bw_status -eq 0
                    echo ""
                    echo "âœ“ SSH configuration backed up successfully"
                    echo "  Item: $item_name"
                    echo "  Hostname: $backup_hostname"
                    echo "  Timestamp: $timestamp"
                    echo ""
                    echo "ðŸ’¡ Run 'fedpunk vault sync' to sync with server"
                else
                    echo "âœ— Failed to create/update backup in Bitwarden"
                    exit 1
                end

            case ssh-restore
                # Restore ~/.ssh directory from Bitwarden
                echo "ðŸ”“ Restoring SSH configuration from Bitwarden..."
                echo ""

                # Check if vault is unlocked
                set bw_status (bw status 2>/dev/null | grep -o '"status":"[^"]*"' | cut -d'"' -f4)
                if test "$bw_status" != "unlocked"
                    echo "âœ— Bitwarden vault is locked"
                    echo "  Run: fedpunk vault unlock"
                    exit 1
                end

                # Sync vault to ensure latest items
                echo "â†’ Syncing vault..."
                if not bw sync >/dev/null 2>&1
                    echo "âš ï¸  Warning: Failed to sync vault, using cached data"
                end
                echo ""

                # Get backup name (optional)
                if test (count $vault_args) -gt 0
                    set backup_name $vault_args[1]
                    set item_name "SSH Config - $backup_name"
                else
                    # No name specified - list available backups
                    set available_backups (bw list items --search "SSH Config" 2>/dev/null | jq -r '.[] | select(.type == 2) | .name')

                    if test -z "$available_backups"
                        echo "âœ— No SSH backups found in Bitwarden"
                        echo "  Run 'fedpunk vault ssh-backup' to create a backup first"
                        exit 1
                    end

                    # If only one backup, use it
                    set backup_count (echo "$available_backups" | wc -l)
                    if test $backup_count -eq 1
                        set item_name (echo "$available_backups" | head -1)
                        echo "Found backup: $item_name"
                    else
                        # Multiple backups - let user choose
                        echo "Available SSH backups:"
                        echo ""
                        if command -v gum >/dev/null 2>&1
                            set item_name (echo "$available_backups" | gum choose --header "Select backup to restore:")
                        else
                            echo "$available_backups" | nl
                            echo ""
                            read -P "Enter number: " choice
                            set item_name (echo "$available_backups" | sed -n "$choice"p)
                        end

                        if test -z "$item_name"
                            echo "âœ— No backup selected"
                            exit 0
                        end
                    end
                end

                echo "Restoring: $item_name"
                echo ""

                # Check if .ssh already exists
                if test -d "$HOME/.ssh"
                    echo "âš ï¸  Warning: ~/.ssh directory already exists"
                    echo ""
                    ls -la "$HOME/.ssh"
                    echo ""
                    read -P "Overwrite existing SSH configuration? [y/N] " -n 1 confirm
                    echo ""

                    if test "$confirm" != "y" -a "$confirm" != "Y"
                        echo "âœ— Restore cancelled"
                        exit 0
                    end

                    # Backup existing .ssh before overwriting
                    set backup_dir "$HOME/.ssh.backup."(date +%Y%m%d-%H%M%S)
                    echo "â†’ Backing up existing .ssh to $backup_dir"
                    mv "$HOME/.ssh" "$backup_dir"
                end

                # Get backup from Bitwarden
                set item (bw get item "$item_name" 2>/dev/null)

                if test -z "$item"
                    echo "âœ— Could not retrieve backup: $item_name"
                    exit 1
                end

                # Extract base64 encoded backup directly from item
                set encoded_backup (echo "$item" | jq -r '.notes' | sed -n '/--- BEGIN SSH BACKUP ---/,/--- END SSH BACKUP ---/p' | sed '1d;$d' | tr -d '\n')

                if test -z "$encoded_backup"
                    echo "âœ— Could not extract backup data from item"
                    exit 1
                end

                # Decode and extract
                echo "â†’ Restoring SSH configuration..."
                set backup_file (mktemp --suffix=.tar.gz)
                echo "$encoded_backup" | base64 -d > "$backup_file"

                # Extract tarball
                tar -xzf "$backup_file" -C "$HOME" 2>/dev/null
                set extract_status $status
                rm -f "$backup_file"

                if test $extract_status -eq 0
                    # Set correct permissions
                    chmod 700 "$HOME/.ssh"
                    chmod 600 "$HOME/.ssh/"* 2>/dev/null
                    chmod 644 "$HOME/.ssh/"*.pub 2>/dev/null
                    chmod 644 "$HOME/.ssh/config" 2>/dev/null

                    echo ""
                    echo "âœ“ SSH configuration restored successfully"
                    echo ""
                    echo "Note: known_hosts excluded - SSH will rebuild it automatically"
                    echo ""
                    echo "Restored files:"
                    ls -la "$HOME/.ssh"
                else
                    echo "âœ— Failed to extract backup"
                    exit 1
                end

            case claude-backup
                # Backup Claude Code long-lived token to Bitwarden
                echo "ðŸ”’ Backing up Claude Code token to Bitwarden..."
                echo ""
                echo "This will generate a long-lived token using 'claude setup-token'"
                echo "that can be restored on fresh installs without re-authenticating."
                echo ""

                # Check if vault is unlocked
                set bw_status (bw status 2>/dev/null | grep -o '"status":"[^"]*"' | cut -d'"' -f4)
                if test "$bw_status" != "unlocked"
                    echo "âœ— Bitwarden vault is locked"
                    echo "  Run: fedpunk vault unlock"
                    exit 1
                end

                # Check if Claude Code is installed
                if not command -v claude >/dev/null 2>&1
                    echo "âœ— Claude Code not installed"
                    echo "  Install first: npm install -g @anthropic-ai/claude-code"
                    exit 1
                end

                # Get backup name (optional)
                if test (count $vault_args) -gt 0
                    set backup_name $vault_args[1]
                    set item_name "Claude Code Token - $backup_name"
                else
                    set item_name "Claude Code Token"
                end

                echo "Backup name: $item_name"
                echo ""

                # Run claude setup-token and capture the output
                echo "â†’ Generating long-lived token..."
                echo "  (This will open a browser window for authentication)"
                echo ""

                set token_output (claude setup-token 2>&1)

                # Extract the token from output (look for sk-ant- prefix)
                set claude_token (echo "$token_output" | grep -o 'sk-ant-[a-zA-Z0-9_-]*' | head -1)

                if test -z "$claude_token"
                    echo "âœ— Failed to generate token"
                    echo "  Output: $token_output"
                    exit 1
                end

                # Setup metadata
                set backup_hostname (hostname)
                set timestamp (date -u +"%Y-%m-%dT%H:%M:%SZ")

                # Check if item exists
                set existing_item (bw get item "$item_name" 2>/dev/null)

                if test -n "$existing_item"
                    # Update existing item
                    echo "â†’ Updating existing backup..."
                    set item_id (echo "$existing_item" | jq -r '.id')

                    # Update password field with token
                    echo "$existing_item" | jq --arg token "$claude_token" --arg notes "Claude Code Long-Lived Token\nHostname: $backup_hostname\nTimestamp: $timestamp\n\nSet as environment variable:\nexport CLAUDE_CODE_OAUTH_TOKEN='$token'" '.login.password = $token | .notes = $notes' | bw encode | bw edit item "$item_id" >/dev/null 2>&1
                    set bw_status $status
                else
                    # Create new item
                    echo "â†’ Creating new backup item..."

                    # Create login item with token as password
                    jq -n --arg name "$item_name" --arg token "$claude_token" --arg notes "Claude Code Long-Lived Token\nHostname: $backup_hostname\nTimestamp: $timestamp\n\nSet as environment variable:\nexport CLAUDE_CODE_OAUTH_TOKEN='\$token'" '{
  organizationId: null,
  folderId: null,
  type: 1,
  name: $name,
  notes: $notes,
  favorite: false,
  login: {
    username: "claude-code",
    password: $token
  }
}' | bw encode | bw create item >/dev/null 2>&1
                    set bw_status $status
                end

                if test $bw_status -eq 0
                    echo ""
                    echo "âœ“ Claude Code token backed up successfully"
                    echo "  Item: $item_name"
                    echo "  Hostname: $backup_hostname"
                    echo "  Timestamp: $timestamp"
                    echo ""
                    echo "ðŸ’¡ Run 'fedpunk vault sync' to sync with server"
                    echo ""
                    echo "Note: This is a long-lived token that won't expire like OAuth tokens."
                else
                    echo "âœ— Failed to create/update backup in Bitwarden"
                    exit 1
                end

            case claude-restore
                # Restore Claude Code long-lived token from Bitwarden
                echo "ðŸ”“ Restoring Claude Code token from Bitwarden..."
                echo ""

                # Check if vault is unlocked
                set bw_status (bw status 2>/dev/null | grep -o '"status":"[^"]*"' | cut -d'"' -f4)
                if test "$bw_status" != "unlocked"
                    echo "âœ— Bitwarden vault is locked"
                    echo "  Run: fedpunk vault unlock"
                    exit 1
                end

                # Sync vault to ensure latest items
                echo "â†’ Syncing vault..."
                if not bw sync >/dev/null 2>&1
                    echo "âš ï¸  Warning: Failed to sync vault, using cached data"
                end
                echo ""

                # Get backup name (optional)
                if test (count $vault_args) -gt 0
                    set backup_name $vault_args[1]
                    set item_name "Claude Code Token - $backup_name"
                else
                    # No name specified - list available backups (type 1 = login)
                    set available_backups (bw list items --search "Claude Code Token" 2>/dev/null | jq -r '.[] | select(.type == 1) | .name')

                    if test -z "$available_backups"
                        echo "âœ— No Claude Code token backups found in Bitwarden"
                        echo "  Run 'fedpunk vault claude-backup' to create a backup first"
                        exit 1
                    end

                    # If only one backup, use it
                    set backup_count (echo "$available_backups" | wc -l)
                    if test $backup_count -eq 1
                        set item_name (echo "$available_backups" | head -1)
                        echo "Found backup: $item_name"
                    else
                        # Multiple backups - let user choose
                        echo "Available Claude Code token backups:"
                        echo ""
                        if command -v gum >/dev/null 2>&1
                            set item_name (echo "$available_backups" | gum choose --header "Select backup to restore:")
                        else
                            echo "$available_backups" | nl
                            echo ""
                            read -P "Enter number: " choice
                            set item_name (echo "$available_backups" | sed -n "$choice"p)
                        end

                        if test -z "$item_name"
                            echo "âœ— No backup selected"
                            exit 0
                        end
                    end
                end

                echo "Restoring: $item_name"
                echo ""

                # Get token from Bitwarden
                set claude_token (bw get password "$item_name" 2>/dev/null)

                if test -z "$claude_token"
                    echo "âœ— Could not retrieve token from: $item_name"
                    exit 1
                end

                # Add to fish config
                set fish_config "$HOME/.config/fish/conf.d/claude-token.fish"
                echo "â†’ Setting up environment variable..."

                # Create conf.d directory if it doesn't exist
                mkdir -p "$HOME/.config/fish/conf.d"

                # Write environment variable to fish config
                echo "# Claude Code OAuth Token (restored from Bitwarden)" > "$fish_config"
                echo "set -gx CLAUDE_CODE_OAUTH_TOKEN '$claude_token'" >> "$fish_config"

                # Also set for current session
                set -gx CLAUDE_CODE_OAUTH_TOKEN "$claude_token"

                echo ""
                echo "âœ“ Claude Code token restored successfully"
                echo ""
                echo "Environment variable set:"
                echo "  \$CLAUDE_CODE_OAUTH_TOKEN (long-lived token)"
                echo ""
                echo "Config file: $fish_config"
                echo ""
                echo "ðŸŽ‰ You can now use Claude Code without logging in!"
                echo "   Just run: claude"
                echo ""
                echo "Note: Restart your shell or run 'source $fish_config' to use in other terminals"

            case env
                if test (count $vault_args) -eq 0
                    echo "Error: Item name required"
                    echo "Usage: fedpunk vault env <name>"
                    exit 1
                end
                bw-env $vault_args

            case '*'
                echo "Unknown vault subcommand: $vault_cmd"
                echo "Run 'fedpunk vault' for help"
                exit 1
        end

    case apply
        # Apply current configuration without git pull
        echo "Applying Fedpunk configuration..."
        echo ""

        # Apply chezmoi changes
        echo "â†’ Applying configuration changes..."
        if command -v chezmoi >/dev/null 2>&1
            if chezmoi apply
                echo "âœ“ Configuration applied"
            else
                echo "âœ— Chezmoi apply failed"
                exit 1
            end
        else
            echo "âœ— Chezmoi not installed"
            echo "  Install with: sudo dnf install chezmoi"
            exit 1
        end

        echo ""
        echo "âœ“ Apply complete!"
        echo ""
        echo "Note: This only applies local changes."
        echo "Run 'fedpunk sync' to pull from git first."

    case sync
        # Sync dotfiles from git and apply changes
        echo "Syncing Fedpunk configuration..."
        echo ""

        # Check if we're in a git repo
        if not test -d "$FEDPUNK_PATH/.git"
            echo "Error: Not a git repository"
            exit 1
        end

        cd "$FEDPUNK_PATH"

        # Check for uncommitted changes
        if not git diff-index --quiet HEAD -- 2>/dev/null
            echo "âš ï¸  Warning: You have uncommitted local changes"
            echo ""
            git status --short
            echo ""
            read -P "Continue with sync anyway? [y/N] " -n 1 confirm
            echo ""
            if test "$confirm" != "y" -a "$confirm" != "Y"
                echo "Sync cancelled"
                exit 0
            end
        end

        # Pull latest changes
        echo "â†’ Pulling latest changes from origin..."
        if git pull
            echo "âœ“ Git pull successful"
        else
            echo "âœ— Git pull failed"
            exit 1
        end

        echo ""

        # Apply chezmoi changes
        echo "â†’ Applying configuration changes..."
        if command -v chezmoi >/dev/null 2>&1
            if chezmoi apply
                echo "âœ“ Configuration applied"
            else
                echo "âœ— Chezmoi apply failed"
                exit 1
            end
        else
            echo "âš ï¸  Chezmoi not installed, skipping config apply"
        end

        echo ""
        echo "âœ“ Sync complete!"
        echo ""
        echo "Note: Profile and theme changes are already active."
        echo "Run 'exec fish' to reload your shell if needed."

    case bluetooth
        # Bluetooth manager
        if command -v bluetui >/dev/null 2>&1
            exec bluetui
        else
            exec $script_dir/fedpunk-bluetooth
        end

    case help
        show_help
        exit 0

    case version
        echo "Fedpunk CLI v1.0.0"
        echo "A modern Fedora development environment"
        if set -q FEDPUNK_PATH
            echo "Installation: $FEDPUNK_PATH"
        end

    case '*'
        echo "Unknown command: $command"
        echo "Run 'fedpunk' or 'fedpunk help' for usage"
        exit 1
end
