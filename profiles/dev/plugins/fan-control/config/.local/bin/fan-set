#!/bin/bash
# Control fan speeds via PWM on Aquacomputer Octo
# Usage: sudo fan-set <fan_number> <speed_percent>
# Example: sudo fan-set 1 50  (set fan 1 to 50%)

HWMON="/sys/class/hwmon/hwmon5"

if [ "$#" -ne 2 ]; then
    echo "Usage: sudo $0 <fan_number> <speed_percent>"
    echo "  fan_number: 1-8"
    echo "  speed_percent: 0-100 (0=off, 100=full speed)"
    echo ""
    echo "Examples:"
    echo "  sudo $0 1 50   # Set fan 1 to 50%"
    echo "  sudo $0 all 75 # Set all fans to 75%"
    exit 1
fi

FAN=$1
PERCENT=$2

# Validate percentage
if [ "$PERCENT" -lt 0 ] || [ "$PERCENT" -gt 100 ]; then
    echo "Error: Speed percentage must be between 0 and 100"
    exit 1
fi

# Convert percentage to PWM value (0-255)
PWM_VALUE=$((PERCENT * 255 / 100))

if [ "$FAN" = "all" ]; then
    echo "Setting all fans to $PERCENT% (PWM: $PWM_VALUE)"
    for i in {1..8}; do
        echo "$PWM_VALUE" > "$HWMON/pwm${i}"
        echo "Fan $i set to $PERCENT%"
    done
else
    # Validate fan number
    if [ "$FAN" -lt 1 ] || [ "$FAN" -gt 8 ]; then
        echo "Error: Fan number must be between 1 and 8"
        exit 1
    fi

    echo "Setting fan $FAN to $PERCENT% (PWM: $PWM_VALUE)"
    echo "$PWM_VALUE" > "$HWMON/pwm${FAN}"

    # Verify the change
    sleep 0.5
    ACTUAL=$(cat "$HWMON/pwm${FAN}")
    echo "Fan $FAN PWM value: $ACTUAL"

    # Show new speed if available
    if [ -f "$HWMON/fan${FAN}_input" ]; then
        sleep 1
        SPEED=$(cat "$HWMON/fan${FAN}_input")
        echo "Fan $FAN speed: $SPEED RPM"
    fi
fi
