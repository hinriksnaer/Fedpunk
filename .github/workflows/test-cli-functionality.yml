name: Test CLI Functionality

on:
  push:
    branches: [ main, unstable ]
  pull_request:
    branches: [ main, unstable ]
  workflow_dispatch:

jobs:
  test-cli:
    runs-on: ubuntu-latest
    container:
      image: fedora:43

    steps:
      - name: Install system dependencies
        run: |
          dnf install -y git fish sudo rpm-build rpmdevtools yq gum jq

      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Build RPM package
        run: |
          bash test/build-rpm.sh

      - name: Install Fedpunk RPM
        run: |
          dnf install -y ~/rpmbuild/RPMS/noarch/fedpunk-*.rpm

      - name: Source Fedpunk environment
        run: |
          source /etc/profile.d/fedpunk.sh
          echo "FEDPUNK_SYSTEM=$FEDPUNK_SYSTEM" >> $GITHUB_ENV
          echo "FEDPUNK_USER=$FEDPUNK_USER" >> $GITHUB_ENV
          echo "FEDPUNK_ROOT=$FEDPUNK_ROOT" >> $GITHUB_ENV

      - name: Run CLI functionality tests
        env:
          HOME: /root
          PATH: /root/.local/bin:/root/.cargo/bin:/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin
        run: |
          source /etc/profile.d/fedpunk.sh
          bash test/test-cli-commands.sh

      - name: Verify CLI summary
        run: |
          echo ""
          echo "========================================="
          echo "CLI Functionality Test Summary"
          echo "========================================="
          echo "Fedpunk version: $(fedpunk --version)"
          echo "Available commands: $(fedpunk --help | grep -A 20 'Commands:' | grep -v 'Commands:' | grep -v '^$' | wc -l)"
          echo "SSH CLI extension: $(fedpunk ssh --help &>/dev/null && echo 'Working' || echo 'Not available')"
          echo "========================================="
          echo ""
          echo "âœ… All CLI tests passed!"
