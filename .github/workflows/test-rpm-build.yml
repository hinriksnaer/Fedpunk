name: Test RPM Build and Installation

on:
  push:
    branches: [ main, feature/copr-packaging ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

jobs:
  # Primary job: Validate spec file with rpkg (ensures COPR build will work)
  validate-copr-spec:
    name: Validate COPR Spec File
    runs-on: ubuntu-latest
    container:
      image: fedora:43
      options: --privileged

    steps:
      - name: Clone repository (replicate COPR's git clone)
        run: |
          # Install git first (minimal container doesn't have it)
          dnf install -y git

          # Clone the repository like COPR does (real git clone, not GitHub Actions checkout)
          git clone https://github.com/${{ github.repository }}.git /workspace
          cd /workspace

          # For PRs, fetch the PR branch
          if [ "${{ github.event_name }}" = "pull_request" ]; then
            git fetch origin +refs/pull/${{ github.event.pull_request.number }}/head:pr-${{ github.event.pull_request.number }}
            git checkout pr-${{ github.event.pull_request.number }}
          else
            # For pushes, checkout the commit directly
            git checkout ${{ github.sha }}
          fi

          # Verify we have a proper git repository
          echo "Git repository status:"
          git log -1 --oneline

      - name: Validate spec file with rpkg
        working-directory: /workspace
        run: |
          bash test/build-rpm-copr-mode.sh

      - name: Upload SRPM artifact
        uses: actions/upload-artifact@v4
        if: success()
        with:
          name: fedpunk-srpm-copr
          path: ~/rpmbuild/SRPMS/fedpunk-*.src.rpm
          retention-days: 30
